{% extends "admin_base.html" %}

{% block content %}
{% if error %}
<div class="mb-4 admin-card border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
    {{ error }}
</div>
{% endif %}

<div class="max-w-3xl">
    <div class="admin-card p-6">
        <form method="post" enctype="multipart/form-data" action="{% if post %}{{ url_for('admin.news_update', post_id=post.id) }}{% else %}{{ url_for('admin.news_create') }}{% endif %}" class="space-y-4" data-news-standalone-form>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Priority</label>
                        <select name="priority" class="admin-input w-full">
                            {% set val = (post.priority if post else 'NORMAL') %}
                            <option value="URGENT" {% if val == 'URGENT' %}selected{% endif %}>URGENT</option>
                            <option value="HIGH" {% if val == 'HIGH' %}selected{% endif %}>HIGH</option>
                            <option value="NORMAL" {% if val == 'NORMAL' %}selected{% endif %}>NORMAL</option>
                            <option value="LOW" {% if val == 'LOW' %}selected{% endif %}>LOW</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Type</label>
                        <input name="news_type" type="text" value="{{ post.news_type if post else '' }}" placeholder="e.g. Notice" class="admin-input w-full" />
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Heading</label>
                    <input name="heading" type="text" value="{{ post.heading if post else '' }}" placeholder="Announcement title" class="admin-input w-full" />
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Body</label>
                    <input type="hidden" name="body_html" value="" data-news-standalone-body-html>
                    <div class="rounded-xl border border-slate-200 overflow-hidden">
                        <div class="flex flex-wrap items-center gap-2 px-3 py-2 bg-slate-50 border-b border-slate-200">
                            <button type="button" class="admin-btn admin-btn-soft text-xs" data-rte-std-cmd="bold" title="Bold" aria-label="Bold"><span class="iconify text-base" data-icon="solar:text-bold"></span></button>
                            <button type="button" class="admin-btn admin-btn-soft text-xs" data-rte-std-cmd="italic" title="Italic" aria-label="Italic"><span class="iconify text-base" data-icon="mdi:format-italic"></span></button>
                            <button type="button" class="admin-btn admin-btn-soft text-xs" data-rte-std-cmd="strikeThrough" title="Strikethrough" aria-label="Strikethrough"><span class="iconify text-base" data-icon="solar:text-cross-outline"></span></button>
                            <button type="button" class="admin-btn admin-btn-soft text-xs" data-rte-std-cmd="formatBlock" data-rte-std-arg="pre" title="Code block" aria-label="Code block"><span class="iconify text-base" data-icon="solar:code-square-outline"></span></button>
                            <button type="button" class="admin-btn admin-btn-soft text-xs" data-rte-std-cmd="insertUnorderedList" title="Bulleted list" aria-label="Bulleted list"><span class="iconify text-base" data-icon="solar:list-outline"></span></button>
                            <button type="button" class="admin-btn admin-btn-soft text-xs" data-rte-std-cmd="insertOrderedList" title="Numbered list" aria-label="Numbered list"><span class="iconify text-base" data-icon="mdi:format-list-numbered"></span></button>
                            <button type="button" class="admin-btn admin-btn-soft text-xs" data-rte-std-cmd="removeFormat" title="Clear formatting" aria-label="Clear formatting"><span class="iconify text-base" data-icon="solar:eraser-outline"></span></button>
                        </div>
                        <div contenteditable="true" class="p-3 text-sm min-h-[160px] focus:outline-none" data-news-standalone-editor>{{ post.body|safe if post else '' }}</div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Attachment (optional)</label>
                    <input type="file" name="attachment" class="admin-input w-full" />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Sender</label>
                        <input name="sender" type="text" value="{{ post.sender if post else '' }}" placeholder="e.g. Principal Office" class="admin-input w-full" />
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Tags</label>
                        <input name="tags" type="text" value="{{ post.tags if post else '' }}" placeholder="Comma-separated tags" class="admin-input w-full" />
                    </div>
                </div>

                <div class="flex items-center justify-end gap-2 pt-2">
                    <button type="submit" class="admin-btn admin-btn-primary inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:check-circle-bold"></span> Save</button>
                </div>
            </form>
    </div>
</div>

<script>
    (function () {
        const form = document.querySelector('[data-news-standalone-form]');
        const editor = document.querySelector('[data-news-standalone-editor]');
        const hidden = document.querySelector('[data-news-standalone-body-html]');
        if (!form || !editor || !hidden) {
            return;
        }

        let lastRange = null;
        function saveSelection() {
            const sel = window.getSelection && window.getSelection();
            if (!sel || sel.rangeCount === 0) {
                return;
            }
            const r = sel.getRangeAt(0);
            if (!editor.contains(r.commonAncestorContainer)) {
                return;
            }
            lastRange = r;
        }

        function restoreSelection() {
            if (!lastRange) {
                return;
            }
            const sel = window.getSelection && window.getSelection();
            if (!sel) {
                return;
            }
            sel.removeAllRanges();
            sel.addRange(lastRange);
        }

        editor.addEventListener('keyup', saveSelection);
        editor.addEventListener('mouseup', saveSelection);
        editor.addEventListener('touchend', saveSelection);
        editor.addEventListener('focus', saveSelection);

        document.querySelectorAll('[data-rte-std-cmd]').forEach((btn) => {
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
            });
            btn.addEventListener('click', () => {
                const cmd = btn.getAttribute('data-rte-std-cmd');
                const arg = btn.getAttribute('data-rte-std-arg');
                editor.focus();
                restoreSelection();
                if (cmd === 'formatBlock' && arg) {
                    document.execCommand(cmd, false, arg);
                } else {
                    document.execCommand(cmd, false, null);
                }
                saveSelection();
            });
        });

        form.addEventListener('submit', () => {
            hidden.value = (editor.innerHTML || '').trim();
        });
    })();
</script>
{% endblock %}
