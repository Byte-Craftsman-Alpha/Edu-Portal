{% set can_moderate = (chat_can_moderate or false) %}

<style>
    :root {
        --gc-bottom-offset: calc(4.75rem + env(safe-area-inset-bottom));
        --gc-scroll-pad-bottom: calc(9.25rem + env(safe-area-inset-bottom));
    }

    [data-gc-composer] :where(.minimal-input) {
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        background: white;
        padding: 10px 16px;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    [data-gc-composer] :where(.minimal-input:focus) {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    [data-gc-composer] :where(textarea.minimal-input) {
        resize: none;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    [data-gc-composer] :where(textarea.minimal-input)::-webkit-scrollbar {
        display: none;
    }

    [data-gc-composer] [data-gc-editor] {
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        background: white;
        padding: 10px 16px;
        font-size: 14px;
        line-height: 20px;
        min-height: 48px;
        max-height: 200px;
        overflow-y: auto;
        outline: none;
        white-space: pre-wrap;
        word-break: break-word;
    }
    [data-gc-composer] [data-gc-editor]:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    [data-gc-composer] [data-gc-editor][data-disabled="1"] {
        background: rgb(241 245 249);
        color: rgb(100 116 139);
        cursor: not-allowed;
    }
    [data-gc-composer] [data-gc-toolbar] button {
        height: 32px;
        min-width: 32px;
        padding: 0 10px;
        border-radius: 12px;
        background: rgb(241 245 249);
        color: rgb(51 65 85);
        font-size: 12px;
        font-weight: 600;
    }
    [data-gc-composer] [data-gc-toolbar] button:hover {
        background: rgb(226 232 240);
    }
    [data-gc-composer] :where(.minimal-btn) {
        border-radius: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    [data-gc-composer] :where(.minimal-btn-primary) {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border: none;
    }
    [data-gc-composer] :where(.minimal-btn-primary:hover) {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }

    [data-gc-message] [data-gc-actions] {
        opacity: 0;
        transform: translateY(-2px);
        pointer-events: none;
        transition: opacity 120ms ease, transform 120ms ease;
    }
    [data-gc-message]:hover [data-gc-actions] {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }
    [data-gc-message] [data-gc-action-btn] {
        width: 32px;
        height: 28px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgb(226 232 240);
        color: rgb(71 85 105);
    }
    [data-gc-message] [data-gc-action-btn]:hover {
        background: rgb(241 245 249);
        color: rgb(15 23 42);
    }

    [data-gc-message][data-gc-pending="1"] {
        opacity: 0.65;
    }

    [data-gc-message-text] {
        line-height: 1.35;
    }

    [data-gc-message-text] ul {
        margin: 0.25rem 0;
        padding-left: 1.1rem;
        list-style: disc !important;
        list-style-position: outside;
    }
    [data-gc-message-text] li {
        margin: 0;
        padding: 0;
    }
</style>

<div class="flex flex-col h-full min-h-0">
    <div class="mt-4 mb-4 flex-1 min-h-0 overflow-y-auto rounded-2xl bg-transparent p-3 hide-scrollbar flex flex-col" data-gc-scroll>
        <div class="flex-1 flex flex-col justify-end gap-3" data-gc-list>
            {% for row in chat_items %}
                {% if row.kind == 'date' %}
                    <div class="flex items-center justify-center py-2" data-gc-date-sep data-date-key="{{ row.date_key }}">
                        <span class="px-3 py-1 rounded-full bg-white border border-slate-200 text-xs text-slate-600">{{ row.label }}</span>
                    </div>
                {% else %}
                    {% set m = row.msg %}
                    {% set mine = (chat_actor and m.actor_type == chat_actor.type and (m.actor_id or 0)|int == (chat_actor.id or 0)|int) %}
                    <div class="w-full flex {% if mine %}justify-end{% else %}justify-start{% endif %}" data-gc-message data-id="{{ m.id }}" data-date="{{ m.date_key }}" data-gc-md="{{ (m.message or '')|e }}">
                        <div class="max-w-[88%] sm:max-w-[75%] flex flex-col min-w-0">
                            <div class="rounded-2xl border {% if mine %}border-emerald-200 bg-emerald-50{% else %}border-slate-200 bg-white{% endif %} p-3 sm:p-4 shadow-sm">
                                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
                                    <button type="button" class="text-left min-w-0" data-gc-profile-btn data-actor-type="{{ m.actor_type }}" data-actor-id="{{ m.actor_id }}">
                                        <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                                            <span class="text-xs font-semibold text-slate-800 truncate max-w-[14rem] hover:underline">{{ m.actor_name }}</span>
                                            <span class="text-[11px] text-slate-400">{{ m.time_label }}</span>
                                            {% if m.edited_at %}
                                                <span class="text-[11px] text-slate-400">(edited{% if m.edited_label %} {{ m.edited_label }}{% endif %})</span>
                                            {% endif %}
                                        </div>
                                    </button>
                                </div>

                            {% if m.message %}
                                <div class="mt-2" data-gc-body>
                                    <div class="text-sm text-slate-800 whitespace-pre-line break-words" data-gc-message-text>{{ m.message|e }}</div>
                                </div>
                            {% endif %}

                            {% if m.attachment_path %}
                                {% set att_url = url_for('static', filename=m.attachment_path) %}
                                {% if m.attachment_is_image %}
                                    <div class="mt-3 rounded-xl border border-slate-200 bg-white overflow-hidden">
                                        <div class="w-full h-56 sm:h-64 bg-slate-50">
                                            <img src="{{ att_url }}" alt="{{ m.attachment_name or 'Image' }}" class="w-full h-full object-cover" />
                                        </div>
                                        <div class="p-2 flex items-center justify-between gap-2 min-w-0">
                                            <p class="text-xs text-slate-600 truncate min-w-0">{{ m.attachment_name or 'Image' }}</p>
                                            <a href="{{ att_url }}" target="_blank" rel="noopener" class="px-2 py-1 rounded-lg minimal-btn minimal-btn-primary text-xs font-medium inline-flex items-center justify-center gap-1 shrink-0"><span class="iconify text-sm" data-icon="solar:eye-bold"></span> View</a>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="mt-3 rounded-xl border border-slate-200 bg-white p-3 flex flex-col gap-2 min-w-0">
                                        <p class="text-xs text-slate-600 flex items-center gap-2 min-w-0">
                                            <span class="iconify shrink-0" data-icon="solar:paperclip-2-linear"></span>
                                            <span class="truncate min-w-0">{{ m.attachment_name or 'Attachment' }}</span>
                                        </p>
                                        <div class="flex items-center justify-center gap-2">
                                            <a href="{{ att_url }}" target="_blank" rel="noopener" class="px-3 py-2 rounded-xl minimal-btn minimal-btn-primary text-xs font-medium inline-flex items-center justify-center gap-2"><span class="iconify text-sm" data-icon="solar:eye-bold"></span> Open</a>
                                            <a href="{{ att_url }}" download class="px-3 py-2 rounded-xl bg-slate-100 text-slate-700 text-xs font-medium hover:bg-slate-200 transition-all inline-flex items-center justify-center gap-2"><span class="iconify text-sm text-indigo-600" data-icon="solar:download-outline"></span> Download</a>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                            </div>

                            <div class="mt-1 flex items-center gap-2 {% if mine %}justify-end{% else %}justify-start{% endif %}" data-gc-actions>
                                {% if mine or can_moderate %}
                                    <button type="button" data-gc-action-btn data-gc-edit-btn data-id="{{ m.id }}" title="Edit">
                                        <span class="iconify text-base" data-icon="solar:pen-2-outline"></span>
                                    </button>
                                {% endif %}
                                {% if mine or can_moderate %}
                                    <button type="button" data-gc-action-btn data-gc-delete-btn data-id="{{ m.id }}" title="Delete">
                                        <span class="iconify text-base" data-icon="solar:trash-bin-trash-outline"></span>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="shrink-0 z-[70] w-full" data-gc-composer>
        <div class="mx-auto w-full max-w-[720px] rounded-3xl border border-slate-200/60 bg-white/70 backdrop-blur-md shadow-[0_10px_28px_rgba(15,23,42,0.08)] p-3">
            {% if not (chat_can_send or false) %}
                <div class="mb-3 rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3">
                    <div class="flex items-start gap-3">
                        <span class="iconify text-xl text-amber-700 mt-0.5" data-icon="solar:shield-warning-bold"></span>
                        <div class="min-w-0">
                            <p class="text-sm font-semibold text-amber-900">You can read messages, but you can’t send new ones.</p>
                            <p class="text-xs text-amber-800 mt-1">Your chat sending permission is currently disabled by the admin. You can request access below.</p>
                            <div class="mt-2 flex items-center gap-2">
                                <button type="button" class="px-3 py-2 rounded-xl minimal-btn minimal-btn-primary text-xs font-medium inline-flex items-center justify-center gap-2" data-gc-request-access>
                                    <span class="iconify text-base" data-icon="solar:mailbox-bold"></span>
                                    Request access
                                </button>
                                <span class="text-xs text-slate-500" data-gc-request-status></span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            <form method="post" action="{{ chat_send_url }}" enctype="multipart/form-data" class="space-y-2" data-gc-form>
                <div class="grid grid-cols-[1fr_auto_auto] gap-2 items-center mb-0">
                    <input type="hidden" name="message" data-gc-message>
                    <div class="w-full" data-gc-editor-wrap>
                        <div data-gc-editor contenteditable="true" spellcheck="true" role="textbox" aria-multiline="true" placeholder="Type a message..." {% if not (chat_can_send or false) %}data-disabled="1"{% endif %}></div>
                    </div>

                    <div>
                        <input type="file" name="attachment" class="hidden" data-gc-attachment>
                        <button type="button" class="w-10 h-10 rounded-2xl bg-slate-100 text-slate-700 hover:bg-slate-200 transition-all inline-flex items-center justify-center" data-gc-attach-btn title="Attach file" {% if not (chat_can_send or false) %}disabled{% endif %}>
                            <span class="iconify text-xl" data-icon="solar:paperclip-outline"></span>
                        </button>
                    </div>

                    <button type="submit" class="w-10 h-10 rounded-2xl minimal-btn minimal-btn-primary inline-flex items-center justify-center" title="Send" {% if not (chat_can_send or false) %}disabled{% endif %}>
                        <span class="iconify text-xl" data-icon="solar:arrow-right-bold"></span>
                    </button>
                </div>

                <div class="text-[11px] text-slate-500 hidden" data-gc-attachment-label></div>
            </form>
        </div>
    </div>
</div>

<div class="fixed inset-0 z-[80] hidden" data-gc-profile-modal>
    <div class="absolute inset-0 bg-slate-900/40" data-gc-profile-backdrop></div>
    <div class="absolute bottom-0 left-0 right-0 sm:bottom-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2">
        <div class="mx-auto max-w-md rounded-t-3xl sm:rounded-3xl border border-slate-200 bg-white shadow-2xl overflow-hidden">
            <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500">Profile</p>
                    <p class="text-lg font-semibold text-slate-900" data-gc-profile-name>Loading…</p>
                </div>
                <button type="button" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-700 text-sm font-medium hover:bg-slate-200 transition-all" data-gc-profile-close>Close</button>
            </div>
            <div class="p-5" data-gc-profile-body>
                <div class="text-sm text-slate-600">Loading…</div>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="groupChatInit">{{ {
    'my_actor': chat_actor,
    'poll_url': chat_poll_url,
    'older_url': chat_older_url,
    'snapshot_url': chat_snapshot_url,
    'oldest_id': chat_oldest_id,
    'has_more': chat_has_more,
    'revision': chat_revision,
    'profile_url_template': chat_profile_url_template,
    'delete_url_template': chat_delete_url_template,
    'edit_url_template': chat_edit_url_template,
    'can_moderate': can_moderate,
    'chat_can_send': (chat_can_send or false)
} | tojson }}</script>

<script>
    (function () {
        const scrollEl = document.querySelector('[data-gc-scroll]');
        const listEl = document.querySelector('[data-gc-list]');
        const formEl = document.querySelector('[data-gc-form]');
        const msgInput = formEl ? formEl.querySelector('[data-gc-message]') : null;
        const editorEl = formEl ? formEl.querySelector('[data-gc-editor]') : null;
        const toolbarEl = formEl ? formEl.querySelector('[data-gc-toolbar]') : null;
        const attachBtn = document.querySelector('[data-gc-attach-btn]');
        const attachInput = document.querySelector('[data-gc-attachment]');
        const attachLabel = document.querySelector('[data-gc-attachment-label]');
        const initEl = document.getElementById('groupChatInit');

        const actionUrl = formEl ? (formEl.getAttribute('action') || '') : '';

        const requestBtn = document.querySelector('[data-gc-request-access]');
        const requestStatus = document.querySelector('[data-gc-request-status]');

        const modal = document.querySelector('[data-gc-profile-modal]');
        const modalBackdrop = document.querySelector('[data-gc-profile-backdrop]');
        const modalClose = document.querySelector('[data-gc-profile-close]');
        const modalName = document.querySelector('[data-gc-profile-name]');
        const modalBody = document.querySelector('[data-gc-profile-body]');

        if (!scrollEl || !listEl || !initEl) return;

        let init = null;
        try {
            init = JSON.parse(initEl.textContent || '{}');
        } catch (e) {
            init = null;
        }

        if (formEl && init && init.chat_can_send === false) {
            formEl.addEventListener('submit', (e) => {
                e.preventDefault();
                if (requestStatus) {
                    requestStatus.textContent = "You don't have permission to send messages.";
                } else {
                    alert("You don't have permission to send messages.");
                }
            });
        }

        if (requestBtn) {
            requestBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                requestBtn.disabled = true;
                if (requestStatus) requestStatus.textContent = 'Sending request…';
                try {
                    const res = await fetch('/chat/request-access', {
                        method: 'POST',
                        headers: { 'Accept': 'application/json' }
                    });
                    const data = await res.json().catch(() => ({}));
                    if (requestStatus) {
                        requestStatus.textContent = data && data.message ? String(data.message) : 'Request sent.';
                    }
                } catch (_) {
                    if (requestStatus) requestStatus.textContent = 'Could not send request. Please try again.';
                } finally {
                    requestBtn.disabled = false;
                }
            });
        }

        function applySnapshot(payload) {
            const items = (payload && payload.items) ? payload.items : [];
            const rev = payload && payload.revision;
            if (typeof rev !== 'undefined') setStoredRevision(rev);

            hasMore = !!(payload && payload.has_more);
            oldestId = (payload && payload.oldest_id) ? payload.oldest_id : null;

            listEl.innerHTML = '';
            items.forEach((it) => {
                if (!it) return;
                if (it.kind === 'date') {
                    listEl.appendChild(renderDateSeparator(it.date_key, it.label || it.date_key || ''));
                    return;
                }
                const m = it.msg;
                if (!m) return;
                maybeInsertDateSeparator(m.date_key, m.date_label);
                listEl.appendChild(renderMessage(m));
            });

            scrollToBottom();
        }

        function upsertMessage(msg) {
            if (!msg || !msg.id) return;
            const existing = listEl.querySelector(`[data-gc-message][data-id="${CSS.escape(String(msg.id))}"]`);
            if (existing) {
                const shouldStickToBottom = isNearBottom();
                const replacement = renderMessage(msg);
                existing.replaceWith(replacement);
                if (shouldStickToBottom) scrollToBottom();
                return;
            }

            const shouldStickToBottom = isNearBottom();
            maybeInsertDateSeparator(msg.date_key, msg.date_label);
            listEl.appendChild(renderMessage(msg));
            if (shouldStickToBottom) scrollToBottom();
        }

        function removeMessage(id) {
            if (!id) return;
            const node = listEl.querySelector(`[data-gc-message][data-id="${CSS.escape(String(id))}"]`);
            if (node) node.remove();
        }

        function pad2(n) {
            const x = Number(n || 0);
            return x < 10 ? `0${x}` : String(x);
        }

        function nowLabels() {
            const d = new Date();
            const dateKey = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
            const timeLabel = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
            return { dateKey, timeLabel };
        }
        if (!init) return;

        const pollUrl = init.poll_url;
        const olderUrl = init.older_url;
        const snapshotUrl = init.snapshot_url;
        const profileUrlTemplate = init.profile_url_template;
        const deleteUrlTemplate = init.delete_url_template;
        const editUrlTemplate = init.edit_url_template;
        const myActor = init.my_actor;
        const canModerate = !!init.can_moderate;

        const REV_KEY = 'eduportal:groupchat:rev';
        function getStoredRevision() {
            try { return Number(window.localStorage.getItem(REV_KEY) || '0') || 0; } catch { return 0; }
        }
        function setStoredRevision(rev) {
            const n = Number(rev || 0) || 0;
            try { window.localStorage.setItem(REV_KEY, String(n)); } catch {}
            currentRevision = n;
        }

        let currentRevision = Number(init.revision || 0) || 0;
        if (currentRevision) setStoredRevision(currentRevision);

        let oldestId = init.oldest_id;
        let hasMore = !!init.has_more;
        let loadingOlder = false;

        const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        function isNearBottom() {
            const threshold = 120;
            return (scrollEl.scrollTop + scrollEl.clientHeight) >= (scrollEl.scrollHeight - threshold);
        }

        function scrollToBottom() {
            scrollEl.scrollTop = scrollEl.scrollHeight;
        }

        // On first paint, keep the view at the newest messages.
        requestAnimationFrame(() => {
            scrollToBottom();
            requestAnimationFrame(scrollToBottom);
            setTimeout(scrollToBottom, 50);
            setTimeout(scrollToBottom, 250);
        });

        // Some layouts settle after DOMContentLoaded (fonts/styles); ensure we end at the bottom.
        document.addEventListener('DOMContentLoaded', () => {
            scrollToBottom();
            setTimeout(scrollToBottom, 0);
        });

        // Ensure bottom scroll even after late-loading assets (images/fonts).
        window.addEventListener('load', () => {
            scrollToBottom();
            setTimeout(scrollToBottom, 0);
        });

        // If images load later, they can change scrollHeight; keep pinned to bottom on initial load.
        scrollEl.querySelectorAll('img').forEach((img) => {
            img.addEventListener('load', () => {
                scrollToBottom();
            }, { once: true });
        });

        async function loadOlder() {
            if (!olderUrl || loadingOlder || !hasMore || !oldestId) return;
            loadingOlder = true;

            const prevHeight = scrollEl.scrollHeight;
            try {
                const url = `${olderUrl}?before_id=${encodeURIComponent(String(oldestId))}&limit=40`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                const data = await res.json();
                if (!data || !data.ok) {
                    hasMore = false;
                } else {
                    hasMore = !!data.has_more;
                    if (data.oldest_id) oldestId = data.oldest_id;

                    const items = data.items || [];
                    // prepend older items in correct order
                    for (let i = items.length - 1; i >= 0; i--) {
                        const it = items[i];
                        if (!it) continue;
                        if (it.kind === 'date') {
                            listEl.prepend(renderDateSeparator(it.date_key, it.label || it.date_key || ''));
                            continue;
                        }
                        const m = it.msg;
                        if (!m) continue;
                        listEl.prepend(renderMessage(m));
                    }
                }
            } catch (e) {
                // ignore
            }

            const newHeight = scrollEl.scrollHeight;
            scrollEl.scrollTop = newHeight - prevHeight;
            loadingOlder = false;
        }

        scrollEl.addEventListener('scroll', () => {
            if (scrollEl.scrollTop <= 40) {
                loadOlder();
            }
        });

        if (attachBtn && attachInput) {
            attachBtn.addEventListener('click', () => attachInput.click());
            attachInput.addEventListener('change', () => {
                if (!attachLabel) return;
                const f = attachInput.files && attachInput.files[0];
                if (!f) {
                    attachLabel.classList.add('hidden');
                    attachLabel.textContent = '';
                    return;
                }
                attachLabel.classList.remove('hidden');
                attachLabel.textContent = `Attachment: ${f.name}`;
            });
        }

        if (editorEl && msgInput) {
            const disabled = init && init.chat_can_send === false;
            disableComposer(!!disabled);

            editorEl.addEventListener('input', () => {
                syncComposerToHidden();
            });
            syncComposerToHidden();
        }

        if (toolbarEl && editorEl) {
            toolbarEl.addEventListener('click', (e) => {
                const btn = e.target && e.target.closest ? e.target.closest('button[data-gc-fmt]') : null;
                if (!btn) return;
                e.preventDefault();
                const kind = btn.getAttribute('data-gc-fmt');
                if (!kind) return;
                applyFormat(kind);
            });
        }

        // Render markdown for server-rendered messages
        listEl.querySelectorAll('[data-gc-message-text]').forEach((el) => {
            const raw = (el.textContent || '').trimEnd();
            el.innerHTML = renderMarkdown(raw);
        });

        function escapeHtml(s) {
            return (s || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function renderMarkdown(md) {
            const raw = String(md || '').replace(/\r\n/g, '\n');

            // Escape first (safe), then we will insert minimal HTML.
            let src = escapeHtml(raw);

            // fenced code blocks
            src = src.replace(/```([\s\S]*?)```/g, (m, code) => {
                return `\n<pre class="mt-2 rounded-xl bg-slate-900 text-slate-100 p-3 overflow-x-auto text-xs"><code>${code.replace(/^\n+|\n+$/g, '')}</code></pre>\n`;
            });

            function renderInline(s) {
                let out = String(s || '');
                out = out.replace(/`([^`\n]+)`/g, (m, code) => `<code class="px-1 py-0.5 rounded bg-slate-100 text-slate-900 text-[12px]">${code}</code>`);
                out = out.replace(/\*\*([^*\n]+)\*\*/g, '<strong>$1</strong>');
                out = out.replace(/\*([^*\n]+)\*/g, '<em>$1</em>');
                out = out.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" class="underline text-indigo-700">$1</a>');
                return out;
            }

            const lines = src.split('\n');
            let html = '';
            let inList = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const m = line.match(/^\s*-\s+(.*)$/);
                if (m) {
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    html += `<li>${renderInline(m[1])}</li>`;
                    continue;
                }

                if (inList) {
                    html += '</ul>';
                    inList = false;
                }

                if (!String(line || '').trim()) {
                    html += '<br>';
                    continue;
                }
                html += `${renderInline(line)}<br>`;
            }
            if (inList) html += '</ul>';

            // Trim trailing <br>
            html = html.replace(/(<br>)+$/g, '');
            return html;
        }

        function normalizeEditorHtml(html) {
            return String(html || '')
                .replace(/<div><br><\/div>/gi, '<br>')
                .replace(/<div>/gi, '')
                .replace(/<\/div>/gi, '<br>')
                .replace(/<p>/gi, '')
                .replace(/<\/p>/gi, '<br>');
        }

        function htmlToMarkdown(html) {
            let s = normalizeEditorHtml(html);

            // convert formatting tags to markdown
            s = s.replace(/<br\s*\/?>(\s*)/gi, '\n');
            s = s.replace(/<(strong|b)>([\s\S]*?)<\/(strong|b)>/gi, '**$2**');
            s = s.replace(/<(em|i)>([\s\S]*?)<\/(em|i)>/gi, '*$2*');
            s = s.replace(/<code>([\s\S]*?)<\/code>/gi, '`$1`');
            s = s.replace(/<ul>([\s\S]*?)<\/ul>/gi, (m, inner) => {
                const items = inner.match(/<li>[\s\S]*?<\/li>/gi) || [];
                return items.map((li) => {
                    const t = li.replace(/^<li>|<\/li>$/gi, '');
                    return `- ${t}`;
                }).join('\n');
            });
            s = s.replace(/<li>([\s\S]*?)<\/li>/gi, '- $1');

            // strip any other tags
            s = s.replace(/<[^>]+>/g, '');

            // decode minimal entities we introduced via contenteditable
            s = s.replace(/&nbsp;/g, ' ');
            s = s.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'");

            // Normalize newlines (handle CRLF from some browsers)
            s = s.replace(/\r\n/g, '\n');

            // Avoid creating extra blank lines between consecutive list items.
            // Example: "- a\n\n- b" -> "- a\n- b"
            s = s.replace(/(^|\n)(-\s[^\n]+)\n{2,}(?=-\s)/g, '$1$2\n');

            // Also handle whitespace-only blank lines between list items.
            s = s.replace(/(^|\n)(-\s[^\n]+)\n(?:[ \t]*\n)+(?=-\s)/g, '$1$2\n');

            // General normalization: collapse 3+ newlines to 2.
            s = s.replace(/\n{3,}/g, '\n\n');

            return s.replace(/^\n+|\n+$/g, '').trim();
        }

        function syncComposerToHidden() {
            if (!editorEl || !msgInput) return;
            const md = htmlToMarkdown(editorEl.innerHTML);
            msgInput.value = md;
        }

        function disableComposer(disabled) {
            if (!editorEl) return;
            if (disabled) {
                editorEl.setAttribute('contenteditable', 'false');
                editorEl.setAttribute('data-disabled', '1');
            } else {
                editorEl.setAttribute('contenteditable', 'true');
                editorEl.removeAttribute('data-disabled');
            }
        }

        function applyFormat(kind) {
            if (!editorEl) return;
            editorEl.focus();
            try {
                if (kind === 'bold') document.execCommand('bold');
                if (kind === 'italic') document.execCommand('italic');
                if (kind === 'ul') document.execCommand('insertUnorderedList');
                if (kind === 'code') {
                    const sel = window.getSelection();
                    if (!sel || sel.rangeCount === 0) return;
                    const range = sel.getRangeAt(0);
                    const text = sel.toString();
                    const node = document.createElement('code');
                    node.textContent = text || '';
                    range.deleteContents();
                    range.insertNode(node);
                    range.setStartAfter(node);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            } catch (_) {
                // ignore
            }
            syncComposerToHidden();
        }

        function openProfileModal() {
            if (!modal) return;
            modal.classList.remove('hidden');
        }

        function closeProfileModal() {
            if (!modal) return;
            modal.classList.add('hidden');
        }

        if (modalBackdrop) modalBackdrop.addEventListener('click', closeProfileModal);
        if (modalClose) modalClose.addEventListener('click', closeProfileModal);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeProfileModal();
        });

        async function showProfile(actorType, actorId) {
            if (!modalName || !modalBody) return;
            modalName.textContent = 'Loading…';
            modalBody.innerHTML = '<div class="text-sm text-slate-600">Loading…</div>';
            openProfileModal();

            try {
                const url = String(profileUrlTemplate)
                    .replace('__TYPE__', encodeURIComponent(actorType))
                    .replace('__ID__', encodeURIComponent(String(actorId)));
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                const data = await res.json();
                if (!data || !data.ok) {
                    modalName.textContent = 'Profile';
                    modalBody.innerHTML = `<div class="text-sm text-rose-700">${escapeHtml(data && data.error ? data.error : 'Unable to load profile')}</div>`;
                    return;
                }
                modalName.textContent = data.name || 'Profile';
                const lines = (data.lines || []).map((l) => `<div class="text-sm text-slate-700">${escapeHtml(l)}</div>`).join('');
                modalBody.innerHTML = lines || '<div class="text-sm text-slate-600">No details available.</div>';
            } catch (e) {
                modalName.textContent = 'Profile';
                modalBody.innerHTML = '<div class="text-sm text-rose-700">Unable to load profile.</div>';
            }
        }

        document.querySelectorAll('[data-gc-profile-btn]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const t = btn.getAttribute('data-actor-type');
                const id = btn.getAttribute('data-actor-id');
                if (!t || !id) return;
                showProfile(t, id);
            });
        });

        async function deleteMessage(messageId) {
            const ok = window.confirm('Delete this message?');
            if (!ok) return;

            try {
                const url = String(deleteUrlTemplate).replace('__ID__', encodeURIComponent(String(messageId)));
                const res = await fetch(url, { method: 'POST', headers: { 'Accept': 'application/json' } });
                const data = await res.json();
                if (!data || !data.ok) {
                    window.alert((data && data.error) ? data.error : 'Failed to delete message');
                    return;
                }
                const node = listEl.querySelector(`[data-gc-message][data-id="${CSS.escape(String(messageId))}"]`);
                if (node) node.remove();
            } catch (e) {
                window.alert('Failed to delete message');
            }
        }

        document.querySelectorAll('[data-gc-delete-btn]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                if (!id) return;
                deleteMessage(id);
            });
        });

        async function editMessage(messageId, newText) {
            try {
                const url = String(editUrlTemplate).replace('__ID__', encodeURIComponent(String(messageId)));
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: newText })
                });
                const data = await res.json();
                if (!data || !data.ok) {
                    window.alert((data && data.error) ? data.error : 'Failed to edit message');
                    return null;
                }
                return data;
            } catch (e) {
                window.alert('Failed to edit message');
                return null;
            }
        }

        function ensureEditedBadge(headerEl, editedLabel) {
            if (!headerEl) return;
            const existing = headerEl.querySelector('[data-gc-edited-badge]');
            if (existing) {
                existing.textContent = editedLabel ? `(edited ${editedLabel})` : '(edited)';
                return;
            }
            const badge = document.createElement('span');
            badge.setAttribute('data-gc-edited-badge', '');
            badge.className = 'text-[11px] text-slate-400';
            badge.textContent = editedLabel ? `(edited ${editedLabel})` : '(edited)';
            headerEl.appendChild(badge);
        }

        function attachInlineEditHandlers(messageRoot) {
            const editBtn = messageRoot.querySelector('[data-gc-edit-btn]');
            if (!editBtn) return;

            editBtn.addEventListener('click', async () => {
                const id = editBtn.getAttribute('data-id');
                if (!id) return;

                const body = messageRoot.querySelector('[data-gc-body]');
                if (!body) return;
                if (body.querySelector('[data-gc-edit-area]')) return;

                const textNode = body.querySelector('[data-gc-message-text]');
                const currentText = String(messageRoot.getAttribute('data-gc-md') || (textNode ? (textNode.textContent || '') : '')).trim();

                const editor = document.createElement('div');
                editor.setAttribute('data-gc-edit-area', '');
                editor.className = 'space-y-2';
                editor.innerHTML = `
                    <textarea class="minimal-input w-full" rows="3" data-gc-edit-input></textarea>
                    <div class="flex items-center justify-end gap-2">
                        <button type="button" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-700 text-xs font-medium hover:bg-slate-200 transition-all" data-gc-edit-cancel>Cancel</button>
                        <button type="button" class="px-3 py-2 rounded-xl minimal-btn minimal-btn-primary text-xs font-medium" data-gc-edit-save>Save</button>
                    </div>
                `;

                const input = editor.querySelector('[data-gc-edit-input]');
                const cancelBtn = editor.querySelector('[data-gc-edit-cancel]');
                const saveBtn = editor.querySelector('[data-gc-edit-save]');
                if (input) input.value = currentText;

                if (textNode) textNode.classList.add('hidden');
                body.appendChild(editor);
                if (input) input.focus();

                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        editor.remove();
                        if (textNode) textNode.classList.remove('hidden');
                    });
                }

                if (saveBtn) {
                    saveBtn.addEventListener('click', async () => {
                        const newText = (input ? input.value : '').trim();
                        if (!newText) {
                            window.alert('Message cannot be empty');
                            return;
                        }
                        const res = await editMessage(id, newText);
                        if (!res) return;

                        if (textNode) {
                            const finalMd = (res.message || newText);
                            messageRoot.setAttribute('data-gc-md', finalMd);
                            textNode.innerHTML = renderMarkdown(finalMd);
                            textNode.classList.remove('hidden');
                        }
                        editor.remove();

                        const header = messageRoot.querySelector('[data-gc-profile-btn] .flex');
                        ensureEditedBadge(header, res.edited_label || '');
                    });
                }
            });
        }

        document.querySelectorAll('[data-gc-message]').forEach((node) => {
            attachInlineEditHandlers(node);
        });

        function renderDateSeparator(dateKey, label) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center justify-center py-2';
            wrapper.setAttribute('data-gc-date-sep', '');
            wrapper.setAttribute('data-date-key', String(dateKey || ''));
            wrapper.innerHTML = `<span class="px-3 py-1 rounded-full bg-white border border-slate-200 text-xs text-slate-600">${escapeHtml(label)}</span>`;
            return wrapper;
        }

        function renderAttachment(m) {
            if (!m.attachment_url) return '';
            if (m.attachment_is_image) {
                return `
                    <div class="mt-3 rounded-xl border border-slate-200 bg-white overflow-hidden">
                        <div class="w-full h-56 sm:h-64 bg-slate-50">
                            <img src="${escapeHtml(m.attachment_url)}" alt="${escapeHtml(m.attachment_name || 'Image')}" class="w-full h-full object-cover" />
                        </div>
                        <div class="p-2 flex items-center justify-between gap-2 min-w-0">
                            <p class="text-xs text-slate-600 truncate min-w-0">${escapeHtml(m.attachment_name || 'Image')}</p>
                            <a href="${escapeHtml(m.attachment_url)}" target="_blank" rel="noopener" class="px-2 py-1 rounded-lg minimal-btn minimal-btn-primary text-xs font-medium inline-flex items-center justify-center gap-1 shrink-0"><span class="iconify text-sm" data-icon="solar:eye-bold"></span> View</a>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="mt-3 rounded-xl border border-slate-200 bg-white p-3 flex flex-col gap-2 min-w-0">
                    <p class="text-xs text-slate-600 flex items-center gap-2 min-w-0">
                        <span class="iconify shrink-0" data-icon="solar:paperclip-2-linear"></span>
                        <span class="truncate min-w-0">${escapeHtml(m.attachment_name || 'Attachment')}</span>
                    </p>
                    <div class="flex items-center justify-end gap-2">
                        <a href="${escapeHtml(m.attachment_url)}" target="_blank" rel="noopener" class="px-3 py-2 rounded-xl minimal-btn minimal-btn-primary text-xs font-medium inline-flex items-center justify-center gap-2"><span class="iconify text-sm" data-icon="solar:eye-bold"></span> Open</a>
                        <a href="${escapeHtml(m.attachment_url)}" download class="px-3 py-2 rounded-xl bg-slate-100 text-slate-700 text-xs font-medium hover:bg-slate-200 transition-all inline-flex items-center justify-center gap-2"><span class="iconify text-sm text-indigo-600" data-icon="solar:download-outline"></span> Download</a>
                    </div>
                </div>
            `;
        }

        function renderMessage(m) {
            const mine = myActor && m.actor_type === myActor.type && Number(m.actor_id || 0) === Number(myActor.id || 0);
            const wrapper = document.createElement('div');
            wrapper.className = `w-full flex ${mine ? 'justify-end' : 'justify-start'}`;
            wrapper.setAttribute('data-gc-message', '');
            wrapper.setAttribute('data-id', String(m.id));
            wrapper.setAttribute('data-date', String(m.date_key || ''));
            wrapper.setAttribute('data-gc-md', String(m.message || ''));

            const editBtn = (mine || canModerate)
                ? `<button type="button" data-gc-action-btn data-gc-edit-btn data-id="${escapeHtml(String(m.id))}" title="Edit"><span class="iconify text-base" data-icon="solar:pen-2-outline"></span></button>`
                : '';
            const deleteBtn = (mine || canModerate)
                ? `<button type="button" data-gc-action-btn data-gc-delete-btn data-id="${escapeHtml(String(m.id))}" title="Delete"><span class="iconify text-base" data-icon="solar:trash-bin-trash-outline"></span></button>`
                : '';

            wrapper.innerHTML = `
                <div class="max-w-[88%] sm:max-w-[75%] flex flex-col min-w-0">
                    <div class="rounded-2xl border ${mine ? 'border-emerald-200 bg-emerald-50' : 'border-slate-200 bg-white'} p-3 sm:p-4 shadow-sm">
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
                            <button type="button" class="text-left min-w-0" data-gc-profile-btn data-actor-type="${escapeHtml(m.actor_type)}" data-actor-id="${escapeHtml(String(m.actor_id))}">
                                <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                                    <span class="text-xs font-semibold text-slate-800 truncate max-w-[14rem] hover:underline">${escapeHtml(m.actor_name || '')}</span>
                                    <span class="text-[11px] text-slate-400">${escapeHtml(m.time_label || '')}</span>
                                    ${m.edited_at ? `<span class="text-[11px] text-slate-400" data-gc-edited-badge>(edited${m.edited_label ? ` ${escapeHtml(m.edited_label)}` : ''})</span>` : ''}
                                </div>
                            </button>
                        </div>
                        ${m.message ? `<div class="mt-2" data-gc-body><div class="text-sm text-slate-800 whitespace-pre-line break-words" data-gc-message-text>${renderMarkdown(m.message)}</div></div>` : ''}
                        ${renderAttachment(m)}
                    </div>
                    <div class="mt-1 flex items-center gap-2 ${mine ? 'justify-end' : 'justify-start'}" data-gc-actions>
                        ${editBtn}
                        ${deleteBtn}
                    </div>
                </div>
            `;

            const profileBtn = wrapper.querySelector('[data-gc-profile-btn]');
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    const t = profileBtn.getAttribute('data-actor-type');
                    const id = profileBtn.getAttribute('data-actor-id');
                    if (!t || !id) return;
                    showProfile(t, id);
                });
            }

            const delBtn = wrapper.querySelector('[data-gc-delete-btn]');
            if (delBtn) {
                delBtn.addEventListener('click', () => {
                    const id = delBtn.getAttribute('data-id');
                    if (!id) return;
                    deleteMessage(id);
                });
            }

            attachInlineEditHandlers(wrapper);

            return wrapper;
        }

        function getLastMessageId() {
            const nodes = listEl.querySelectorAll('[data-gc-message][data-id]');
            let last = 0;
            nodes.forEach((n) => {
                const id = Number(n.getAttribute('data-id') || 0);
                if (id > last) last = id;
            });
            return last;
        }

        function maybeInsertDateSeparator(dateKey, dateLabel) {
            const last = listEl.lastElementChild;
            const lastMsg = last && last.matches && last.matches('[data-gc-message]') ? last : null;
            const lastSep = last && last.matches && last.matches('[data-gc-date-sep]') ? last : null;
            const lastDate = lastMsg
                ? lastMsg.getAttribute('data-date')
                : (lastSep ? lastSep.getAttribute('data-date-key') : null);
            if (!lastDate || String(lastDate) !== String(dateKey)) {
                listEl.appendChild(renderDateSeparator(dateKey, dateLabel || dateKey || ''));
            }
        }

        // Socket.IO realtime updates
        const hasSocket = typeof window.io === 'function';
        if (hasSocket) {
            try {
                const socket = window.io({ transports: ['websocket', 'polling'] });

                socket.on('connect', () => {
                    const localRev = getStoredRevision() || currentRevision || 0;
                    socket.emit('chat:sync', { revision: Number(localRev) || 0 });
                });

                socket.on('chat:rev', (payload) => {
                    const rev = payload && payload.revision;
                    if (typeof rev !== 'undefined') setStoredRevision(rev);
                });

                socket.on('chat:snapshot', (payload) => {
                    applySnapshot(payload);
                });

                socket.on('chat:new', (payload) => {
                    const msg = payload && payload.msg;
                    if (!msg) return;
                    if (payload && typeof payload.revision !== 'undefined') setStoredRevision(payload.revision);
                    upsertMessage(msg);
                    if (!prefersReducedMotion && document.visibilityState !== 'visible') {
                        // no-op
                    }
                });

                socket.on('chat:edited', (payload) => {
                    const msg = payload && payload.msg;
                    if (!msg) return;
                    if (payload && typeof payload.revision !== 'undefined') setStoredRevision(payload.revision);
                    upsertMessage(msg);
                });

                socket.on('chat:deleted', (payload) => {
                    const id = payload && payload.id;
                    removeMessage(id);
                    if (payload && typeof payload.revision !== 'undefined') setStoredRevision(payload.revision);
                });
            } catch (e) {
                // fall back to polling
            }
        }

        // Fallback polling if Socket.IO not available
        async function poll() {
            if (!pollUrl) return;
            try {
                const shouldStickToBottom = isNearBottom();
                const afterId = getLastMessageId();
                const url = `${pollUrl}?after_id=${encodeURIComponent(String(afterId))}&limit=50`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                const data = await res.json();
                if (!data || !data.ok) return;

                const items = data.items || [];
                if (!items.length) return;

                items.forEach((it) => {
                    if (it.kind === 'date') {
                        listEl.appendChild(renderDateSeparator(it.label || it.date_key || ''));
                        return;
                    }
                    const m = it.msg;
                    if (!m) return;
                    upsertMessage(m);
                });

                if (shouldStickToBottom) scrollToBottom();
            } catch (e) {
                // ignore
            }
        }

        if (!hasSocket) {
            setInterval(poll, 4000);
        }

        const isMobile = (
            (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) ||
            (window.matchMedia && window.matchMedia('(max-width: 640px)').matches)
        );

        let sending = false;
        async function ajaxSend() {
            if (sending) return;
            if (!formEl) return;
            syncComposerToHidden();
            if (!msgInput) return;
            const message = (msgInput.value || '').trim();
            const hasAttachment = !!(attachInput && attachInput.files && attachInput.files[0]);
            if (!message && !hasAttachment) return;

            const tempId = `local-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            let optimisticNode = null;
            try {
                const labels = nowLabels();
                const optimisticMsg = {
                    id: tempId,
                    actor_type: myActor ? myActor.type : 'student',
                    actor_id: myActor ? myActor.id : 0,
                    actor_name: myActor ? myActor.name : 'Me',
                    message: message || null,
                    attachment_url: null,
                    attachment_name: hasAttachment && attachInput && attachInput.files && attachInput.files[0] ? attachInput.files[0].name : null,
                    attachment_is_image: false,
                    time_label: labels.timeLabel,
                    date_key: labels.dateKey,
                    date_label: null,
                    edited_at: null,
                    edited_label: null,
                };

                optimisticNode = renderMessage(optimisticMsg);
                optimisticNode.setAttribute('data-gc-pending', '1');
                maybeInsertDateSeparator(optimisticMsg.date_key, optimisticMsg.date_key);
                listEl.appendChild(optimisticNode);
                scrollToBottom();
            } catch (_) {
                optimisticNode = null;
            }

            sending = true;
            try {
                const fd = new FormData(formEl);
                const res = await fetch(actionUrl || '/chat/send', {
                    method: 'POST',
                    headers: { 'Accept': 'application/json' },
                    body: fd
                });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || !data.ok) {
                    if (!data) {
                        const txt = await res.text().catch(() => '');
                        window.alert(txt ? `Failed to send message: ${txt}` : 'Failed to send message');
                    } else {
                        window.alert((data && data.error) ? data.error : 'Failed to send message');
                    }
                    if (optimisticNode) {
                        optimisticNode.setAttribute('data-gc-pending', '0');
                        optimisticNode.style.opacity = '1';
                    }
                    return;
                }

                if (typeof data.revision !== 'undefined') setStoredRevision(data.revision);

                // Reconcile optimistic message with the authoritative server message.
                if (optimisticNode) optimisticNode.remove();
                if (data && data.msg) {
                    upsertMessage(data.msg);
                }

                if (msgInput) msgInput.value = '';
                if (editorEl) editorEl.innerHTML = '';
                if (attachInput) attachInput.value = '';
                if (attachLabel) {
                    attachLabel.classList.add('hidden');
                    attachLabel.textContent = '';
                }
            } catch (e) {
                window.alert('Failed to send message');
                if (optimisticNode) {
                    optimisticNode.setAttribute('data-gc-pending', '0');
                    optimisticNode.style.opacity = '1';
                }
            } finally {
                sending = false;
            }
        }

        if (formEl && editorEl) {
            editorEl.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                if (isMobile) return;
                if (e.shiftKey) return;
                e.preventDefault();
                ajaxSend();
            });
        }

        if (formEl) {
            formEl.addEventListener('submit', (e) => {
                e.preventDefault();
                ajaxSend();
            });
        }

        // Push Notifications (header bell toggle)
        const pushBtn = document.querySelector('[data-gc-push-btn]');
        const pushIcon = document.querySelector('[data-gc-push-icon]');
        let pushEnabled = false;

        function setPushIcon(enabled) {
            pushEnabled = !!enabled;
            if (!pushIcon) return;
            pushIcon.setAttribute('data-icon', enabled ? 'solar:bell-bing-outline' : 'solar:bell-off-outline');
            if (pushBtn) pushBtn.title = enabled ? 'Notifications enabled' : 'Notifications disabled';
        }

        async function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function ensureServiceWorker() {
            if (!('serviceWorker' in navigator)) return null;
            try {
                return await navigator.serviceWorker.register('/sw.js');
            } catch {
                return null;
            }
        }

        async function getVapidKey() {
            const res = await fetch('/push/vapid-public-key', { headers: { 'Accept': 'application/json' } });
            const data = await res.json();
            return (data && data.public_key) ? String(data.public_key) : '';
        }

        async function setServerToggle(enabled) {
            await fetch('/push/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ enabled: !!enabled })
            });
        }

        async function refreshPushState() {
            try {
                const res = await fetch('/push/status', { headers: { 'Accept': 'application/json' } });
                const data = await res.json();
                setPushIcon(!!(data && data.enabled));
            } catch {
                setPushIcon(false);
            }
        }

        async function subscribePush() {
            const reg = await ensureServiceWorker();
            if (!reg) {
                window.alert('Push notifications are not supported in this browser.');
                return null;
            }
            const key = await getVapidKey();
            if (!key) {
                window.alert('Push is not configured on server (missing VAPID keys).');
                return null;
            }

            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                return null;
            }

            const existing = await reg.pushManager.getSubscription();
            const sub = existing || await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: await urlBase64ToUint8Array(key)
            });

            await fetch('/push/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ subscription: sub })
            });

            return sub;
        }

        if (pushBtn) {
            refreshPushState();
            pushBtn.addEventListener('click', async () => {
                if (pushEnabled) {
                    await setServerToggle(false);
                    setPushIcon(false);
                    return;
                }

                const sub = await subscribePush();
                if (!sub) {
                    await setServerToggle(false);
                    setPushIcon(false);
                    return;
                }

                await setServerToggle(true);
                setPushIcon(true);
            });
        }
    })();
</script>
