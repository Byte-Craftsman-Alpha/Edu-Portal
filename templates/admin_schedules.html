{% extends "admin_base.html" %}

{% block content %}
{% if error %}
<div class="mb-4 admin-card border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
    {{ error }}
</div>
{% endif %}

<div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <div class="admin-card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-slate-900">Monthly Events &amp; Holidays</h2>
            <span class="text-xs text-slate-500">Global</span>
        </div>

        <form method="post" action="{{ url_for('admin_calendar_item_create') }}" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
            <input name="item_date" type="date" class="admin-input" />
            <select name="item_type" class="admin-input">
                <option value="">Type</option>
                <option value="HOLIDAY">Holiday</option>
                <option value="EVENT">Event</option>
                <option value="EXAM">Exam</option>
                <option value="NOTICE">Notice</option>
            </select>
            <input name="title" type="text" placeholder="Title" class="admin-input" />
            <input name="description" type="text" placeholder="Description (optional)" class="admin-input" />
            <div class="md:col-span-2 flex justify-end">
                <button type="submit" class="admin-btn admin-btn-primary inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:add-square-bold"></span> Add</button>
            </div>
        </form>

        <div class="mb-4">
            <input id="monthlySearch" type="text" placeholder="Search monthly items..." class="admin-input w-full" />
        </div>

        {% if calendar_items %}
            <div id="monthlyItems" class="grid grid-cols-1 gap-4">
                {% for it in calendar_items %}
                    <details class="rounded-2xl border border-slate-200 bg-white" data-search="{{ it.item_date }} {{ it.item_type }} {{ it.title }} {{ it.description }}">
                        <summary class="list-none cursor-pointer select-none p-4">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">{{ it.item_date }}</div>
                                    <div class="mt-1 flex items-center gap-2">
                                        <span class="admin-pill bg-slate-100 text-slate-700 text-xs">{{ it.item_type }}</span>
                                        <span class="text-sm font-semibold text-slate-900 truncate">{{ it.title }}</span>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400 mt-1">Expand</div>
                            </div>
                        </summary>

                        <div class="px-4 pb-4">
                            <div class="pt-3 border-t border-slate-100">
                                {% if it.description %}
                                    <div class="text-sm text-slate-600 break-words">{{ it.description }}</div>
                                {% else %}
                                    <div class="text-sm text-slate-400">No description</div>
                                {% endif %}
                            </div>

                            <form method="post" action="{{ url_for('admin_calendar_item_update', item_id=it.id) }}" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-4">
                                <div>
                                    <label class="block text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-1">Date</label>
                                    <input name="item_date" type="date" value="{{ it.item_date }}" class="admin-input w-full" />
                                </div>
                                <div>
                                    <label class="block text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-1">Type</label>
                                    <select name="item_type" class="admin-input w-full">
                                        <option value="HOLIDAY" {% if it.item_type == 'HOLIDAY' %}selected{% endif %}>Holiday</option>
                                        <option value="EVENT" {% if it.item_type == 'EVENT' %}selected{% endif %}>Event</option>
                                        <option value="EXAM" {% if it.item_type == 'EXAM' %}selected{% endif %}>Exam</option>
                                        <option value="NOTICE" {% if it.item_type == 'NOTICE' %}selected{% endif %}>Notice</option>
                                    </select>
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-1">Title</label>
                                    <input name="title" type="text" value="{{ it.title }}" class="admin-input w-full" />
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-1">Description</label>
                                    <input name="description" type="text" value="{{ it.description }}" class="admin-input w-full" />
                                </div>
                                <div class="sm:col-span-2 flex items-center justify-end gap-2 pt-1">
                                    <button type="submit" class="admin-btn admin-btn-soft text-xs inline-flex items-center gap-2"><span class="iconify text-sm text-amber-600" data-icon="solar:pen-2-outline"></span> Update</button>
                            </form>
                                    <form method="post" action="{{ url_for('admin_calendar_item_delete', item_id=it.id) }}" onsubmit="return confirm('Delete this item?');">
                                        <button type="submit" class="admin-btn admin-btn-danger text-xs inline-flex items-center gap-2"><span class="iconify text-sm text-rose-200" data-icon="solar:trash-bin-trash-outline"></span> Delete</button>
                                    </form>
                                </div>
                        </div>
                    </details>
                {% endfor %}
            </div>
        {% else %}
            <div class="rounded-xl border border-dashed border-slate-200 p-6 text-sm text-slate-500">No monthly items yet.</div>
        {% endif %}
    </div>

    <div class="admin-card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-slate-900">Weekly Timetable</h2>
            <span class="text-xs text-slate-500">Add / Delete</span>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50/40 p-4 mb-6">
            <p class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Schedule Group</p>
            <form method="get" action="{{ url_for('admin_schedules') }}" class="mt-3 flex flex-col sm:flex-row gap-2">
                <select name="schedule_id" class="admin-input flex-1">
                    {% for g in schedule_groups or [] %}
                        <option value="{{ g.id }}" {% if selected_schedule_id is defined and g.id == selected_schedule_id %}selected{% endif %}>
                            {{ g.name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="admin-btn admin-btn-primary inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:refresh-outline"></span> Load</button>
            </form>

            <details class="mt-4">
                <summary class="list-none cursor-pointer select-none text-sm font-semibold text-slate-900">Create new schedule group</summary>
                <form method="post" action="{{ url_for('admin_schedule_group_create') }}" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <input name="name" type="text" placeholder="Group name" class="admin-input" />
                    <input name="semester" type="number" min="1" max="12" placeholder="Semester (optional)" class="admin-input" />
                    <input name="program" type="text" placeholder="Program (optional)" class="admin-input" />
                    <input name="department" type="text" placeholder="Department (optional)" class="admin-input" />
                    <div class="sm:col-span-2 flex justify-end pt-1">
                        <button type="submit" class="admin-btn admin-btn-soft inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:add-square-outline"></span> Create</button>
                    </div>
                </form>
            </details>
        </div>

        <form method="post" action="{{ url_for('admin_timetable_create') }}" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
            <input type="hidden" name="schedule_id" value="{{ selected_schedule_id if selected_schedule_id is defined else 1 }}" />
            <select name="day_of_week" class="admin-input">
                <option value="">Day of week</option>
                <option value="0">Monday</option>
                <option value="1">Tuesday</option>
                <option value="2">Wednesday</option>
                <option value="3">Thursday</option>
                <option value="4">Friday</option>
                <option value="5">Saturday</option>
                <option value="6">Sunday</option>
            </select>
            <input name="subject" type="text" placeholder="Subject" class="admin-input" />
            <input name="room" type="text" placeholder="Room" class="admin-input" />
            <input name="instructor" type="text" placeholder="Instructor" class="admin-input" />
            <input name="start_time" type="time" class="admin-input" />
            <input name="end_time" type="time" class="admin-input" />
            <div class="md:col-span-2 flex justify-end">
                <button type="submit" class="admin-btn admin-btn-primary inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:add-square-bold"></span> Add Timetable Row</button>
            </div>
        </form>

        <div class="mb-4">
            <input id="weeklySearch" type="text" placeholder="Search weekly timetable..." class="admin-input w-full" />
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50/40 p-4 mb-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                    <input id="weeklySelectAll" type="checkbox" class="rounded border-slate-300" />
                    Select all
                    <span id="weeklySelectedCount" class="text-xs text-slate-500">(0 selected)</span>
                </label>
                <div class="flex items-center gap-2">
                    <button id="weeklyBulkDelete" type="button" class="admin-btn admin-btn-danger text-xs inline-flex items-center gap-2" disabled>
                        <span class="iconify text-sm text-rose-200" data-icon="solar:trash-bin-trash-outline"></span>
                        Delete selected
                    </button>
                    <button id="weeklyBulkUpdateToggle" type="button" class="admin-btn admin-btn-soft text-xs inline-flex items-center gap-2" disabled>
                        <span class="iconify text-sm text-amber-600" data-icon="solar:pen-2-outline"></span>
                        Edit selected
                    </button>
                </div>
            </div>

            <div id="weeklyBulkUpdatePanel" class="mt-4 hidden">
                <form id="weeklyBulkUpdateForm" method="post" action="{{ url_for('admin_timetable_bulk_update') }}" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <input type="hidden" name="schedule_id" value="{{ selected_schedule_id if selected_schedule_id is defined else 1 }}" />
                    <input type="hidden" name="row_ids" value="" />

                    <select name="day_of_week" class="admin-input">
                        <option value="">Day of week (optional)</option>
                        <option value="0">Monday</option>
                        <option value="1">Tuesday</option>
                        <option value="2">Wednesday</option>
                        <option value="3">Thursday</option>
                        <option value="4">Friday</option>
                        <option value="5">Saturday</option>
                        <option value="6">Sunday</option>
                    </select>
                    <input name="subject" type="text" placeholder="Subject (optional)" class="admin-input" />
                    <input name="room" type="text" placeholder="Room (optional)" class="admin-input" />
                    <input name="instructor" type="text" placeholder="Instructor (optional)" class="admin-input" />
                    <input name="start_time" type="time" class="admin-input" />
                    <input name="end_time" type="time" class="admin-input" />

                    <div class="sm:col-span-2 flex items-center justify-end gap-2 pt-1">
                        <button id="weeklyBulkUpdateCancel" type="button" class="admin-btn admin-btn-soft text-xs">Cancel</button>
                        <button type="submit" class="admin-btn admin-btn-primary text-xs inline-flex items-center gap-2">
                            <span class="iconify text-sm" data-icon="solar:check-circle-bold"></span>
                            Apply changes
                        </button>
                    </div>
                </form>

                <form id="weeklyBulkDeleteForm" method="post" action="{{ url_for('admin_timetable_bulk_delete') }}" class="hidden">
                    <input type="hidden" name="schedule_id" value="{{ selected_schedule_id if selected_schedule_id is defined else 1 }}" />
                </form>
            </div>
        </div>

        {% if timetable_by_group %}
            <div id="weeklyItems" class="space-y-6">
                {% for g in schedule_groups or [] %}
                    {% set rows = timetable_by_group.get(g.id) %}
                    {% if rows %}
                        <div class="rounded-2xl border border-slate-200 bg-white">
                            <div class="p-4 border-b border-slate-100 flex items-center justify-between gap-3">
                                <div>
                                    <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Schedule Group</div>
                                    <div class="text-sm font-semibold text-slate-900">{{ g.name }}</div>
                                </div>
                                <span class="text-xs text-slate-400">{{ rows|length }} rows</span>
                            </div>
                            <div class="p-4 grid grid-cols-1 gap-3">
                                {% for r in rows %}
                                    {% set day_label = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][r.day_of_week] if r.day_of_week is not none else '' %}
                                    <details class="rounded-2xl border border-slate-200 bg-white" data-search="{{ g.name }} {{ day_label }} {{ r.start_time }} {{ r.end_time }} {{ r.subject }} {{ r.room }} {{ r.instructor }}">
                                        <summary class="list-none cursor-pointer select-none p-4">
                                            <div class="flex items-start justify-between gap-3">
                                                <div class="flex items-start gap-3 min-w-0">
                                                    <label class="pt-1">
                                                        <input type="checkbox" class="weeklyRowCheckbox rounded border-slate-300" value="{{ r.id }}" />
                                                    </label>
                                                    <div class="min-w-0">
                                                        <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">{{ day_label }} • {{ r.start_time }} - {{ r.end_time }}</div>
                                                        <div class="mt-1 text-sm font-semibold text-slate-900 truncate">{{ r.subject }}</div>
                                                        <div class="text-sm text-slate-600 mt-1">Room: {{ r.room }} • Instructor: {{ r.instructor }}</div>
                                                    </div>
                                                </div>
                                                <div class="text-xs text-slate-400 mt-1">Expand</div>
                                            </div>
                                        </summary>

                                        <div class="px-4 pb-4">
                                            <div class="pt-3 border-t border-slate-100">
                                                <div class="text-sm text-slate-600">Group: <span class="text-slate-900 font-semibold">{{ g.name }}</span></div>
                                                <div class="text-sm text-slate-600 mt-1">Day: <span class="text-slate-900 font-semibold">{{ day_label }}</span></div>
                                                <div class="text-sm text-slate-600 mt-1">Time: <span class="text-slate-900 font-semibold">{{ r.start_time }} - {{ r.end_time }}</span></div>
                                                <div class="text-sm text-slate-600 mt-1">Room: <span class="text-slate-900 font-semibold">{{ r.room }}</span></div>
                                                <div class="text-sm text-slate-600 mt-1">Instructor: <span class="text-slate-900 font-semibold">{{ r.instructor }}</span></div>
                                            </div>

                                            <form method="post" action="{{ url_for('admin_timetable_update', row_id=r.id, schedule_id=(selected_schedule_id if selected_schedule_id is defined else 1)) }}" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-4">
                                                <input type="hidden" name="schedule_id" value="{{ g.id }}" />
                                                <select name="day_of_week" class="admin-input">
                                                    <option value="0" {% if r.day_of_week == 0 %}selected{% endif %}>Monday</option>
                                                    <option value="1" {% if r.day_of_week == 1 %}selected{% endif %}>Tuesday</option>
                                                    <option value="2" {% if r.day_of_week == 2 %}selected{% endif %}>Wednesday</option>
                                                    <option value="3" {% if r.day_of_week == 3 %}selected{% endif %}>Thursday</option>
                                                    <option value="4" {% if r.day_of_week == 4 %}selected{% endif %}>Friday</option>
                                                    <option value="5" {% if r.day_of_week == 5 %}selected{% endif %}>Saturday</option>
                                                    <option value="6" {% if r.day_of_week == 6 %}selected{% endif %}>Sunday</option>
                                                </select>
                                                <input name="subject" type="text" value="{{ r.subject }}" class="admin-input" />
                                                <input name="room" type="text" value="{{ r.room }}" class="admin-input" />
                                                <input name="instructor" type="text" value="{{ r.instructor }}" class="admin-input" />
                                                <input name="start_time" type="time" value="{{ r.start_time }}" class="admin-input" />
                                                <input name="end_time" type="time" value="{{ r.end_time }}" class="admin-input" />
                                                <div class="sm:col-span-2 flex items-center justify-end pt-1">
                                                    <button type="submit" class="admin-btn admin-btn-soft text-xs inline-flex items-center gap-2"><span class="iconify text-sm text-amber-600" data-icon="solar:pen-2-outline"></span> Update</button>
                                                </div>
                                            </form>

                                            <div class="flex items-center justify-end gap-2 mt-2">
                                                <form method="post" action="{{ url_for('admin_timetable_delete', row_id=r.id, schedule_id=(selected_schedule_id if selected_schedule_id is defined else 1)) }}" onsubmit="return confirm('Delete this timetable row?');">
                                                    <button type="submit" class="admin-btn admin-btn-danger text-xs inline-flex items-center gap-2"><span class="iconify text-sm text-rose-200" data-icon="solar:trash-bin-trash-outline"></span> Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                    </details>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                {% if not timetable_rows %}
                    <div class="rounded-xl border border-dashed border-slate-200 p-6 text-sm text-slate-500">No timetable rows yet.</div>
                {% endif %}
            </div>
        {% else %}
            <div class="rounded-xl border border-dashed border-slate-200 p-6 text-sm text-slate-500">No timetable rows yet.</div>
        {% endif %}
    </div>
</div>

<script>
    (function () {
        function wireSearch(inputId, containerId) {
            var input = document.getElementById(inputId);
            var container = document.getElementById(containerId);
            if (!input || !container) return;

            function apply() {
                var q = (input.value || "").toLowerCase().trim();
                var items = container.querySelectorAll('[data-search]');
                for (var i = 0; i < items.length; i++) {
                    var hay = (items[i].getAttribute('data-search') || '').toLowerCase();
                    items[i].style.display = !q || hay.indexOf(q) !== -1 ? '' : 'none';
                }
            }

            input.addEventListener('input', apply);
            apply();
        }

        wireSearch('monthlySearch', 'monthlyItems');
        wireSearch('weeklySearch', 'weeklyItems');

        var selectAll = document.getElementById('weeklySelectAll');
        var selectedCount = document.getElementById('weeklySelectedCount');
        var bulkDeleteBtn = document.getElementById('weeklyBulkDelete');
        var bulkUpdateToggle = document.getElementById('weeklyBulkUpdateToggle');
        var bulkPanel = document.getElementById('weeklyBulkUpdatePanel');
        var bulkCancel = document.getElementById('weeklyBulkUpdateCancel');
        var bulkUpdateForm = document.getElementById('weeklyBulkUpdateForm');
        var bulkDeleteForm = document.getElementById('weeklyBulkDeleteForm');

        function getRowCheckboxes() {
            var container = document.getElementById('weeklyItems');
            if (!container) return [];
            return Array.prototype.slice.call(container.querySelectorAll('.weeklyRowCheckbox'));
        }

        function getSelectedIds() {
            return getRowCheckboxes().filter(function (cb) { return cb.checked; }).map(function (cb) { return cb.value; });
        }

        function syncSelectedUi() {
            var ids = getSelectedIds();
            if (selectedCount) {
                selectedCount.textContent = '(' + ids.length + ' selected)';
            }
            var has = ids.length > 0;
            if (bulkDeleteBtn) bulkDeleteBtn.disabled = !has;
            if (bulkUpdateToggle) bulkUpdateToggle.disabled = !has;
            if (bulkUpdateForm) {
                var hidden = bulkUpdateForm.querySelector('input[name="row_ids"]');
                if (hidden) hidden.value = ids.join(',');
            }
            if (bulkDeleteForm) {
                var hidden2 = bulkDeleteForm.querySelector('input[name="row_ids"]');
                if (hidden2) hidden2.value = ids.join(',');
            }
            if (selectAll) {
                var all = getRowCheckboxes();
                var allChecked = all.length > 0 && all.every(function (cb) { return cb.checked; });
                selectAll.checked = allChecked;
            }
        }

        if (selectAll) {
            selectAll.addEventListener('change', function () {
                var all = getRowCheckboxes();
                all.forEach(function (cb) { cb.checked = selectAll.checked; });
                syncSelectedUi();
            });
        }

        getRowCheckboxes().forEach(function (cb) {
            cb.addEventListener('change', syncSelectedUi);
        });

        if (bulkUpdateToggle && bulkPanel) {
            bulkUpdateToggle.addEventListener('click', function () {
                bulkPanel.classList.toggle('hidden');
            });
        }
        if (bulkCancel && bulkPanel) {
            bulkCancel.addEventListener('click', function () {
                bulkPanel.classList.add('hidden');
            });
        }

        function setHiddenIds(form, ids) {
            if (!form) return;
            form.querySelectorAll('input[data-weekly-selected="1"]').forEach(function (n) { n.remove(); });
            ids.forEach(function (id) {
                var inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'row_ids';
                inp.value = id;
                inp.setAttribute('data-weekly-selected', '1');
                form.appendChild(inp);
            });
        }

        if (bulkDeleteBtn && bulkDeleteForm) {
            bulkDeleteBtn.addEventListener('click', function () {
                if (!confirm('Delete selected timetable rows?')) return;
                var ids = getSelectedIds();
                setHiddenIds(bulkDeleteForm, ids);
                bulkDeleteForm.submit();
            });
        }

        if (bulkUpdateForm) {
            bulkUpdateForm.addEventListener('submit', function (e) {
                var ids = getSelectedIds();
                setHiddenIds(bulkUpdateForm, ids);
            });
        }

        syncSelectedUi();
    })();
</script>
{% endblock %}
