{% extends "admin_base.html" %}

{% block content %}
{% if error %}
<div class="mb-4 admin-card border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
    {{ error }}
</div>
{% endif %}

{% if success %}
<div class="mb-4 admin-card border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700">
    {{ success }}
</div>
{% endif %}

<div class="admin-card p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
            <p class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Import / Export Schedules</p>
            <p class="text-sm text-slate-600 mt-1">Weekly timetable and monthly items can be downloaded/uploaded as JSON.</p>
        </div>
        <a href="{{ url_for('admin_schedules_export') }}" class="admin-btn admin-btn-soft inline-flex items-center gap-2">
            <span class="iconify text-base" data-icon="solar:download-minimalistic-outline"></span>
            Export JSON
        </a>
    </div>

    <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
        Importing schedules may overwrite existing data if you enable replacement. Make sure you have exported a backup before importing.
    </div>

    <form id="scheduleImportForm" method="post" action="{{ url_for('admin_schedules_import') }}" enctype="multipart/form-data" class="mt-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <input id="scheduleImportFile" name="schedule_json" type="file" accept="application/json,.json" class="admin-input sm:col-span-2" />

            <div class="sm:col-span-2 flex flex-col sm:flex-row sm:items-center sm:justify-end gap-2 pt-1">
                <button id="scheduleImportPreviewBtn" type="button" class="admin-btn admin-btn-soft inline-flex items-center justify-center gap-2" disabled>
                    <span class="iconify text-base" data-icon="solar:eye-outline"></span>
                    Preview import
                </button>
            </div>
        </div>

        <input type="hidden" name="replace_weekly" value="0" />
        <input type="hidden" name="delete_missing_groups" value="0" />
        <input type="hidden" name="import_monthly" value="0" />
        <input type="hidden" name="replace_monthly" value="0" />
    </form>
</div>

<div id="scheduleImportModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div id="scheduleImportModalBackdrop" class="fixed inset-0 bg-slate-900/50 z-40"></div>
    <div class="min-h-full w-full flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-2xl rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden relative z-50">
            <div class="px-5 py-4 border-b border-slate-100 flex items-start justify-between gap-3">
                <div class="min-w-0">
                    <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Import preview</div>
                    <div class="text-sm font-semibold text-slate-900 mt-1">Review what will be imported</div>
                    <div class="text-sm text-slate-600 mt-1">Choose options and confirm to start importing.</div>
                </div>
                <button id="scheduleImportModalClose" type="button" class="admin-btn admin-btn-soft text-xs">Close</button>
            </div>

            <div class="p-5 max-h-[78vh] overflow-auto">
                <div id="scheduleImportPreviewError" class="hidden mb-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700"></div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                    <div class="rounded-xl border border-slate-200 bg-slate-50/40 p-4">
                        <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Weekly groups</div>
                        <div id="previewWeeklyGroups" class="mt-1 text-2xl font-semibold text-slate-900">-</div>
                    </div>
                    <div class="rounded-xl border border-slate-200 bg-slate-50/40 p-4">
                        <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Weekly rows</div>
                        <div id="previewWeeklyRows" class="mt-1 text-2xl font-semibold text-slate-900">-</div>
                    </div>
                    <div class="rounded-xl border border-slate-200 bg-slate-50/40 p-4">
                        <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Monthly items</div>
                        <div id="previewMonthly" class="mt-1 text-2xl font-semibold text-slate-900">-</div>
                    </div>
                </div>

                <div class="rounded-xl border border-slate-200 p-4 mb-4">
                    <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Weekly groups breakdown</div>
                    <div id="previewWeeklyGroupsList" class="mt-2 max-h-56 overflow-auto text-sm text-slate-700"></div>
                </div>

                <div class="rounded-xl border border-slate-200 p-4">
                    <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-2">Import options</div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="flex items-start gap-2 text-sm text-slate-700">
                            <input id="optReplaceWeekly" type="checkbox" class="mt-0.5 rounded border-slate-300" />
                            <span>Replace weekly timetable rows for imported groups</span>
                        </label>
                        <label class="flex items-start gap-2 text-sm text-slate-700">
                            <input id="optDeleteMissingGroups" type="checkbox" class="mt-0.5 rounded border-slate-300" />
                            <span>Delete groups not present in JSON (only when replacing weekly)</span>
                        </label>
                        <label class="flex items-start gap-2 text-sm text-slate-700">
                            <input id="optImportMonthly" type="checkbox" class="mt-0.5 rounded border-slate-300" checked />
                            <span>Import monthly schedules (events/holidays)</span>
                        </label>
                        <label class="flex items-start gap-2 text-sm text-slate-700">
                            <input id="optReplaceMonthly" type="checkbox" class="mt-0.5 rounded border-slate-300" />
                            <span>Replace all monthly schedules (deletes existing monthly items)</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-slate-100 bg-white flex flex-col sm:flex-row sm:items-center sm:justify-end gap-2">
                <button id="scheduleImportConfirm" type="button" class="admin-btn admin-btn-primary inline-flex items-center justify-center gap-2">
                    <span class="iconify text-base" data-icon="solar:upload-minimalistic-outline"></span>
                    Confirm import
                </button>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <div class="admin-card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-slate-900">Monthly Events &amp; Holidays</h2>
            <span class="text-xs text-slate-500">Global</span>
        </div>

        <form method="post" action="{{ url_for('admin_calendar_item_create') }}" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
            <input name="item_date" type="date" class="admin-input" />
            <select name="item_type" class="admin-input">
                <option value="">Type</option>
                <option value="HOLIDAY">Holiday</option>
                <option value="EVENT">Event</option>
                <option value="EXAM">Exam</option>
                <option value="NOTICE">Notice</option>
            </select>
            <input name="title" type="text" placeholder="Title" class="admin-input" />
            <input name="description" type="text" placeholder="Description (optional)" class="admin-input" />
            <div class="md:col-span-2 flex justify-end">
                <button type="submit" class="admin-btn admin-btn-primary inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:add-square-bold"></span> Add</button>
            </div>
        </form>

        <div class="mb-4">
            <input id="monthlySearch" type="text" placeholder="Search monthly items..." class="admin-input w-full" />
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50/40 p-4 mb-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                    <input id="monthlySelectAll" type="checkbox" class="rounded border-slate-300" />
                    Select all
                    <span id="monthlySelectedCount" class="text-xs text-slate-500">(0 selected)</span>
                </label>
                <button id="monthlyBulkDelete" type="button" class="admin-btn admin-btn-danger text-xs inline-flex items-center gap-2" disabled>
                    <span class="iconify text-sm" data-icon="solar:trash-bin-trash-outline"></span>
                    Delete selected
                </button>
            </div>
            <form id="monthlyBulkDeleteForm" method="post" action="{{ url_for('admin_calendar_items_bulk_delete') }}"></form>
        </div>

        {% if calendar_items %}
            <div id="monthlyItems" class="grid grid-cols-1 gap-4">
                {% for it in calendar_items %}
                    <details class="rounded-2xl border border-slate-200 bg-white" data-search="{{ it.item_date }} {{ it.item_type }} {{ it.title }} {{ it.description }}">
                        <summary class="list-none cursor-pointer select-none p-4">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">{{ it.item_date }}</div>
                                    <div class="mt-1 flex items-center gap-2">
                                        <input type="checkbox" class="monthlyItemCheckbox rounded border-slate-300" value="{{ it.id }}" />
                                        <span class="admin-pill bg-slate-100 text-slate-700 text-xs">{{ it.item_type }}</span>
                                        <span class="text-sm font-semibold text-slate-900 truncate">{{ it.title }}</span>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400 mt-1">Expand</div>
                            </div>
                        </summary>

                        <div class="px-4 pb-4">
                            <div class="pt-3 border-t border-slate-100">
                                {% if it.description %}
                                    <div class="text-sm text-slate-600 break-words">{{ it.description }}</div>
                                {% else %}
                                    <div class="text-sm text-slate-400">No description</div>
                                {% endif %}
                            </div>

                            <form method="post" action="{{ url_for('admin_calendar_item_update', item_id=it.id) }}" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-4">
                                <div>
                                    <label class="block text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-1">Date</label>
                                    <input name="item_date" type="date" value="{{ it.item_date }}" class="admin-input w-full" />
                                </div>
                                <div>
                                    <label class="block text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-1">Type</label>
                                    <select name="item_type" class="admin-input w-full">
                                        <option value="HOLIDAY" {% if it.item_type == 'HOLIDAY' %}selected{% endif %}>Holiday</option>
                                        <option value="EVENT" {% if it.item_type == 'EVENT' %}selected{% endif %}>Event</option>
                                        <option value="EXAM" {% if it.item_type == 'EXAM' %}selected{% endif %}>Exam</option>
                                        <option value="NOTICE" {% if it.item_type == 'NOTICE' %}selected{% endif %}>Notice</option>
                                    </select>
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-1">Title</label>
                                    <input name="title" type="text" value="{{ it.title }}" class="admin-input w-full" />
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-1">Description</label>
                                    <input name="description" type="text" value="{{ it.description }}" class="admin-input w-full" />
                                </div>
                                <div class="sm:col-span-2 flex items-center justify-end gap-2 pt-1">
                                    <button type="submit" class="admin-btn admin-btn-soft text-xs inline-flex items-center gap-2"><span class="iconify text-sm text-amber-600" data-icon="solar:pen-2-outline"></span> Update</button>
                            </form>
                                    <form method="post" action="{{ url_for('admin_calendar_item_delete', item_id=it.id) }}" onsubmit="return confirm('Delete this item?');">
                                        <button type="submit" class="admin-btn admin-btn-danger text-xs inline-flex items-center gap-2"><span class="iconify text-sm" data-icon="solar:trash-bin-trash-outline"></span> Delete</button>
                                    </form>
                                </div>
                        </div>
                    </details>
                {% endfor %}
            </div>
        {% else %}
            <div class="rounded-xl border border-dashed border-slate-200 p-6 text-sm text-slate-500">No monthly items yet.</div>
        {% endif %}
    </div>

    <div class="admin-card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-slate-900">Weekly Timetable</h2>
            <span class="text-xs text-slate-500">Add / Delete</span>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50/40 p-4 mb-6">
            <p class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Schedule Group</p>
            <form method="get" action="{{ url_for('admin_schedules') }}" class="mt-3 flex flex-col sm:flex-row gap-2">
                <select name="schedule_id" class="admin-input flex-1">
                    {% for g in schedule_groups or [] %}
                        <option value="{{ g.id }}" {% if selected_schedule_id is defined and g.id == selected_schedule_id %}selected{% endif %}>
                            {{ g.name }}
                        </option>
                    {% endfor %}
                </select>
                <div class="flex items-center gap-2">
                    <button type="submit" class="admin-btn admin-btn-primary inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:refresh-outline"></span> Load</button>
                    <button id="scheduleGroupEditToggle" type="button" class="admin-btn admin-btn-soft inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:pen-2-outline"></span> Edit</button>
                </div>
            </form>

            {% set ns = namespace(selected_group=None) %}
            {% for g in schedule_groups or [] %}
                {% if selected_schedule_id is defined and g.id == selected_schedule_id %}
                    {% set ns.selected_group = g %}
                {% endif %}
            {% endfor %}

            {% if ns.selected_group %}
                <form id="scheduleGroupRenameForm" method="post" action="{{ url_for('admin_schedule_group_update', group_id=ns.selected_group.id, schedule_id=ns.selected_group.id) }}" class="mt-3 flex flex-col sm:flex-row gap-2 hidden">
                    <input type="hidden" name="schedule_id" value="{{ ns.selected_group.id }}" />
                    <input name="name" type="text" value="{{ ns.selected_group.name }}" class="admin-input flex-1" />
                    <button type="submit" class="admin-btn admin-btn-soft inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:pen-2-outline"></span> Rename</button>
                </form>

                <form method="post" action="{{ url_for('admin_schedule_group_delete', group_id=ns.selected_group.id, schedule_id=ns.selected_group.id) }}" class="mt-2" onsubmit="return confirm('Delete this schedule group? This will delete all weekly timetable rows in this group. Students assigned to this group will be moved to Default Schedule.');">
                    <input type="hidden" name="schedule_id" value="{{ ns.selected_group.id }}" />
                    <button type="submit" class="admin-btn admin-btn-danger text-xs inline-flex items-center gap-2">
                        <span class="iconify text-sm" data-icon="solar:trash-bin-trash-outline"></span>
                        Delete Schedule Group
                    </button>
                </form>
            {% endif %}

            <details class="mt-4">
                <summary class="list-none cursor-pointer select-none text-sm font-semibold text-slate-900">Create new schedule group</summary>
                <form method="post" action="{{ url_for('admin_schedule_group_create') }}" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <input name="name" type="text" placeholder="Group name" class="admin-input" />
                    <input name="semester" type="number" min="1" max="12" placeholder="Semester (optional)" class="admin-input" />
                    <input name="program" type="text" placeholder="Program (optional)" class="admin-input" />
                    <input name="department" type="text" placeholder="Department (optional)" class="admin-input" />
                    <div class="sm:col-span-2 flex justify-end pt-1">
                        <button type="submit" class="admin-btn admin-btn-soft inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:add-square-outline"></span> Create</button>
                    </div>
                </form>
            </details>
        </div>

        <form method="post" action="{{ url_for('admin_timetable_create') }}" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
            <input type="hidden" name="schedule_id" value="{{ selected_schedule_id if selected_schedule_id is defined else 1 }}" />
            <select name="day_of_week" class="admin-input">
                <option value="">Day of week</option>
                <option value="0">Monday</option>
                <option value="1">Tuesday</option>
                <option value="2">Wednesday</option>
                <option value="3">Thursday</option>
                <option value="4">Friday</option>
                <option value="5">Saturday</option>
                <option value="6">Sunday</option>
            </select>
            <input name="subject" type="text" placeholder="Subject" class="admin-input" />
            <input name="room" type="text" placeholder="Room" class="admin-input" />
            <input name="instructor" type="text" placeholder="Instructor" class="admin-input" />
            <input name="start_time" type="time" class="admin-input" />
            <input name="end_time" type="time" class="admin-input" />
            <div class="md:col-span-2 flex justify-end">
                <button type="submit" class="admin-btn admin-btn-primary inline-flex items-center gap-2"><span class="iconify text-base" data-icon="solar:add-square-bold"></span> Add Timetable Row</button>
            </div>
        </form>

        <div class="mb-4">
            <input id="weeklySearch" type="text" placeholder="Search weekly timetable..." class="admin-input w-full" />
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50/40 p-4 mb-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                    <input id="weeklySelectAll" type="checkbox" class="rounded border-slate-300" />
                    Select all
                    <span id="weeklySelectedCount" class="text-xs text-slate-500">(0 selected)</span>
                </label>
                <div class="flex items-center gap-2">
                    <button id="weeklyBulkDelete" type="button" class="admin-btn admin-btn-danger text-xs inline-flex items-center gap-2" disabled>
                        <span class="iconify text-sm" data-icon="solar:trash-bin-trash-outline"></span>
                        Delete selected
                    </button>
                    <button id="weeklyBulkUpdateToggle" type="button" class="admin-btn admin-btn-soft text-xs inline-flex items-center gap-2" disabled>
                        <span class="iconify text-sm text-amber-600" data-icon="solar:pen-2-outline"></span>
                        Edit selected
                    </button>
                </div>
            </div>

            <div id="weeklyBulkUpdatePanel" class="mt-4 hidden">
                <form id="weeklyBulkUpdateForm" method="post" action="{{ url_for('admin_timetable_bulk_update') }}" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <input type="hidden" name="schedule_id" value="{{ selected_schedule_id if selected_schedule_id is defined else 1 }}" />
                    <input type="hidden" name="row_ids" value="" />

                    <select name="day_of_week" class="admin-input">
                        <option value="">Day of week (optional)</option>
                        <option value="0">Monday</option>
                        <option value="1">Tuesday</option>
                        <option value="2">Wednesday</option>
                        <option value="3">Thursday</option>
                        <option value="4">Friday</option>
                        <option value="5">Saturday</option>
                        <option value="6">Sunday</option>
                    </select>
                    <input name="subject" type="text" placeholder="Subject (optional)" class="admin-input" />
                    <input name="room" type="text" placeholder="Room (optional)" class="admin-input" />
                    <input name="instructor" type="text" placeholder="Instructor (optional)" class="admin-input" />
                    <input name="start_time" type="time" class="admin-input" />
                    <input name="end_time" type="time" class="admin-input" />

                    <div class="sm:col-span-2 flex items-center justify-end gap-2 pt-1">
                        <button id="weeklyBulkUpdateCancel" type="button" class="admin-btn admin-btn-soft text-xs">Cancel</button>
                        <button type="submit" class="admin-btn admin-btn-primary text-xs inline-flex items-center gap-2">
                            <span class="iconify text-sm" data-icon="solar:check-circle-bold"></span>
                            Apply changes
                        </button>
                    </div>
                </form>

                <form id="weeklyBulkDeleteForm" method="post" action="{{ url_for('admin_timetable_bulk_delete') }}" class="hidden">
                    <input type="hidden" name="schedule_id" value="{{ selected_schedule_id if selected_schedule_id is defined else 1 }}" />
                </form>
            </div>
        </div>

        {% if timetable_rows %}
            <div class="rounded-2xl border border-slate-200 bg-white mb-4">
                <div class="p-4 border-b border-slate-100 flex items-center justify-between gap-3">
                    <div>
                        <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Loaded Group</div>
                        <div class="text-sm font-semibold text-slate-900">{{ ns.selected_group.name if ns.selected_group else 'Schedule Group' }}</div>
                    </div>
                    <span class="text-xs text-slate-400">{{ timetable_rows|length }} rows</span>
                </div>
            </div>

            <div id="weeklyItems" class="grid grid-cols-1 gap-3">
                {% for r in timetable_rows %}
                    {% set day_label = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][r.day_of_week] if r.day_of_week is not none else '' %}
                    <details class="rounded-2xl border border-slate-200 bg-white" data-search="{{ ns.selected_group.name if ns.selected_group else '' }} {{ day_label }} {{ r.start_time }} {{ r.end_time }} {{ r.subject }} {{ r.room }} {{ r.instructor }}">
                        <summary class="list-none cursor-pointer select-none p-4">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex items-start gap-3 min-w-0">
                                    <label class="pt-1">
                                        <input type="checkbox" class="weeklyRowCheckbox rounded border-slate-300" value="{{ r.id }}" />
                                    </label>
                                    <div class="min-w-0">
                                        <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">{{ day_label }} • {{ r.start_time }} - {{ r.end_time }}</div>
                                        <div class="mt-1 text-sm font-semibold text-slate-900 truncate">{{ r.subject }}</div>
                                        <div class="text-sm text-slate-600 mt-1">Room: {{ r.room }} • Instructor: {{ r.instructor }}</div>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400 mt-1">Expand</div>
                            </div>
                        </summary>

                        <div class="px-4 pb-4">
                            <div class="pt-3 border-t border-slate-100">
                                <div class="text-sm text-slate-600">Day: <span class="text-slate-900 font-semibold">{{ day_label }}</span></div>
                                <div class="text-sm text-slate-600 mt-1">Time: <span class="text-slate-900 font-semibold">{{ r.start_time }} - {{ r.end_time }}</span></div>
                                <div class="text-sm text-slate-600 mt-1">Room: <span class="text-slate-900 font-semibold">{{ r.room }}</span></div>
                                <div class="text-sm text-slate-600 mt-1">Instructor: <span class="text-slate-900 font-semibold">{{ r.instructor }}</span></div>
                            </div>

                            <form method="post" action="{{ url_for('admin_timetable_update', row_id=r.id, schedule_id=(selected_schedule_id if selected_schedule_id is defined else 1)) }}" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-4">
                                <input type="hidden" name="schedule_id" value="{{ selected_schedule_id if selected_schedule_id is defined else 1 }}" />
                                                <select name="day_of_week" class="admin-input">
                                                    <option value="0" {% if r.day_of_week == 0 %}selected{% endif %}>Monday</option>
                                                    <option value="1" {% if r.day_of_week == 1 %}selected{% endif %}>Tuesday</option>
                                                    <option value="2" {% if r.day_of_week == 2 %}selected{% endif %}>Wednesday</option>
                                                    <option value="3" {% if r.day_of_week == 3 %}selected{% endif %}>Thursday</option>
                                                    <option value="4" {% if r.day_of_week == 4 %}selected{% endif %}>Friday</option>
                                                    <option value="5" {% if r.day_of_week == 5 %}selected{% endif %}>Saturday</option>
                                                    <option value="6" {% if r.day_of_week == 6 %}selected{% endif %}>Sunday</option>
                                                </select>
                                                <input name="subject" type="text" value="{{ r.subject }}" class="admin-input" />
                                                <input name="room" type="text" value="{{ r.room }}" class="admin-input" />
                                                <input name="instructor" type="text" value="{{ r.instructor }}" class="admin-input" />
                                                <input name="start_time" type="time" value="{{ r.start_time }}" class="admin-input" />
                                                <input name="end_time" type="time" value="{{ r.end_time }}" class="admin-input" />
                                                <div class="sm:col-span-2 flex items-center justify-end pt-1">
                                                    <button type="submit" class="admin-btn admin-btn-soft text-xs inline-flex items-center gap-2"><span class="iconify text-sm text-amber-600" data-icon="solar:pen-2-outline"></span> Update</button>
                                                </div>
                                            </form>

                                            <div class="flex items-center justify-end gap-2 mt-2">
                                                <form method="post" action="{{ url_for('admin_timetable_delete', row_id=r.id, schedule_id=(selected_schedule_id if selected_schedule_id is defined else 1)) }}" onsubmit="return confirm('Delete this timetable row?');">
                                                    <button type="submit" class="admin-btn admin-btn-danger text-xs inline-flex items-center gap-2"><span class="iconify text-sm" data-icon="solar:trash-bin-trash-outline"></span> Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                    </details>
                {% endfor %}
            </div>
        {% else %}
            <div class="rounded-xl border border-dashed border-slate-200 p-6 text-sm text-slate-500">No timetable rows yet.</div>
        {% endif %}
    </div>
</div>

<script>
    (function () {
        var scheduleImportForm = document.getElementById('scheduleImportForm');
        var scheduleImportFile = document.getElementById('scheduleImportFile');
        var scheduleImportPreviewBtn = document.getElementById('scheduleImportPreviewBtn');
        var scheduleImportModal = document.getElementById('scheduleImportModal');
        var scheduleImportModalClose = document.getElementById('scheduleImportModalClose');
        var scheduleImportConfirm = document.getElementById('scheduleImportConfirm');
        var scheduleImportPreviewError = document.getElementById('scheduleImportPreviewError');
        var previewWeeklyGroups = document.getElementById('previewWeeklyGroups');
        var previewWeeklyRows = document.getElementById('previewWeeklyRows');
        var previewMonthly = document.getElementById('previewMonthly');
        var previewWeeklyGroupsList = document.getElementById('previewWeeklyGroupsList');

        var optReplaceWeekly = document.getElementById('optReplaceWeekly');
        var optDeleteMissingGroups = document.getElementById('optDeleteMissingGroups');
        var optImportMonthly = document.getElementById('optImportMonthly');
        var optReplaceMonthly = document.getElementById('optReplaceMonthly');

        function setScheduleImportModalOpen(isOpen) {
            if (!scheduleImportModal) return;
            scheduleImportModal.classList.toggle('hidden', !isOpen);
        }

        function setPreviewError(msg) {
            if (!scheduleImportPreviewError) return;
            if (!msg) {
                scheduleImportPreviewError.classList.add('hidden');
                scheduleImportPreviewError.textContent = '';
                return;
            }
            scheduleImportPreviewError.classList.remove('hidden');
            scheduleImportPreviewError.textContent = msg;
        }

        function setText(el, text) {
            if (!el) return;
            el.textContent = text;
        }

        function syncImportOptionDeps() {
            if (optDeleteMissingGroups && optReplaceWeekly) {
                optDeleteMissingGroups.disabled = !optReplaceWeekly.checked;
                if (!optReplaceWeekly.checked) optDeleteMissingGroups.checked = false;
            }
            if (optReplaceMonthly && optImportMonthly) {
                optReplaceMonthly.disabled = !optImportMonthly.checked;
                if (!optImportMonthly.checked) optReplaceMonthly.checked = false;
            }
        }

        if (optReplaceWeekly) optReplaceWeekly.addEventListener('change', syncImportOptionDeps);
        if (optImportMonthly) optImportMonthly.addEventListener('change', syncImportOptionDeps);
        syncImportOptionDeps();

        if (scheduleImportFile && scheduleImportPreviewBtn) {
            scheduleImportFile.addEventListener('change', function () {
                scheduleImportPreviewBtn.disabled = !(scheduleImportFile.files && scheduleImportFile.files.length);
            });
        }

        if (scheduleImportModalClose) {
            scheduleImportModalClose.addEventListener('click', function () {
                setScheduleImportModalOpen(false);
            });
        }
        var scheduleImportModalBackdrop = document.getElementById('scheduleImportModalBackdrop');
        if (scheduleImportModalBackdrop) {
            scheduleImportModalBackdrop.addEventListener('click', function () {
                setScheduleImportModalOpen(false);
            });
        }

        async function previewImport() {
            setPreviewError('');
            setText(previewWeeklyGroups, '-');
            setText(previewWeeklyRows, '-');
            setText(previewMonthly, '-');
            if (previewWeeklyGroupsList) previewWeeklyGroupsList.textContent = '';

            if (!scheduleImportFile || !(scheduleImportFile.files && scheduleImportFile.files.length)) {
                setPreviewError('Please choose a JSON file first.');
                return;
            }

            var fd = new FormData();
            fd.append('schedule_json', scheduleImportFile.files[0]);

            var resp;
            try {
                resp = await fetch('{{ url_for("admin_schedules_import_preview") }}', {
                    method: 'POST',
                    body: fd,
                    credentials: 'same-origin'
                });
            } catch (e) {
                setPreviewError('Failed to contact server for preview.');
                return;
            }

            var data = null;
            try {
                data = await resp.json();
            } catch (e2) {
                setPreviewError('Preview response was not valid JSON.');
                return;
            }

            if (!resp.ok || !data || data.ok !== true) {
                setPreviewError((data && data.error) ? data.error : 'Unable to preview import.');
                return;
            }

            setText(previewWeeklyGroups, String(data.weekly_groups_count || 0));
            setText(previewWeeklyRows, String(data.weekly_total_rows || 0));
            setText(previewMonthly, String(data.monthly_count || 0));

            if (previewWeeklyGroupsList) {
                var groups = Array.isArray(data.weekly_groups) ? data.weekly_groups : [];
                if (!groups.length) {
                    previewWeeklyGroupsList.textContent = 'No weekly schedule groups found in this JSON.';
                } else {
                    var frag = document.createDocumentFragment();
                    groups.forEach(function (g) {
                        var row = document.createElement('div');
                        row.className = 'flex items-center justify-between gap-3 py-1 border-b border-slate-100 last:border-b-0';
                        var left = document.createElement('div');
                        left.className = 'min-w-0 truncate';
                        left.textContent = g.name || '(Unnamed group)';
                        var right = document.createElement('div');
                        right.className = 'text-xs text-slate-500';
                        right.textContent = String(g.rows || 0) + ' rows';
                        row.appendChild(left);
                        row.appendChild(right);
                        frag.appendChild(row);
                    });
                    previewWeeklyGroupsList.appendChild(frag);
                }
            }

            syncImportOptionDeps();
            setScheduleImportModalOpen(true);
        }

        if (scheduleImportPreviewBtn) {
            scheduleImportPreviewBtn.addEventListener('click', function () {
                previewImport();
            });
        }

        function setHiddenValue(form, name, value) {
            if (!form) return;
            var input = form.querySelector('input[name="' + name + '"]');
            if (input) input.value = value;
        }

        if (scheduleImportConfirm && scheduleImportForm) {
            scheduleImportConfirm.addEventListener('click', function () {
                syncImportOptionDeps();
                setHiddenValue(scheduleImportForm, 'replace_weekly', (optReplaceWeekly && optReplaceWeekly.checked) ? '1' : '0');
                setHiddenValue(scheduleImportForm, 'delete_missing_groups', (optDeleteMissingGroups && optDeleteMissingGroups.checked) ? '1' : '0');
                setHiddenValue(scheduleImportForm, 'import_monthly', (optImportMonthly && optImportMonthly.checked) ? '1' : '0');
                setHiddenValue(scheduleImportForm, 'replace_monthly', (optReplaceMonthly && optReplaceMonthly.checked) ? '1' : '0');

                if (!confirm('Warning: Importing schedules may overwrite/erase existing schedules (depending on options).\n\nDo you want to continue?')) {
                    return;
                }
                scheduleImportForm.submit();
            });
        }

        function wireSearch(inputId, containerId) {
            var input = document.getElementById(inputId);
            var container = document.getElementById(containerId);
            if (!input || !container) return;

            function apply() {
                var q = (input.value || "").toLowerCase().trim();
                var items = container.querySelectorAll('[data-search]');
                for (var i = 0; i < items.length; i++) {
                    var hay = (items[i].getAttribute('data-search') || '').toLowerCase();
                    items[i].style.display = !q || hay.indexOf(q) !== -1 ? '' : 'none';
                }
            }

            input.addEventListener('input', apply);
            apply();
        }

        wireSearch('monthlySearch', 'monthlyItems');
        wireSearch('weeklySearch', 'weeklyItems');

        var monthlySelectAll = document.getElementById('monthlySelectAll');
        var monthlySelectedCount = document.getElementById('monthlySelectedCount');
        var monthlyBulkDeleteBtn = document.getElementById('monthlyBulkDelete');
        var monthlyBulkDeleteForm = document.getElementById('monthlyBulkDeleteForm');

        var selectAll = document.getElementById('weeklySelectAll');
        var selectedCount = document.getElementById('weeklySelectedCount');
        var bulkDeleteBtn = document.getElementById('weeklyBulkDelete');
        var bulkUpdateToggle = document.getElementById('weeklyBulkUpdateToggle');
        var bulkPanel = document.getElementById('weeklyBulkUpdatePanel');
        var bulkCancel = document.getElementById('weeklyBulkUpdateCancel');
        var bulkUpdateForm = document.getElementById('weeklyBulkUpdateForm');
        var bulkDeleteForm = document.getElementById('weeklyBulkDeleteForm');
        var scheduleGroupEditToggle = document.getElementById('scheduleGroupEditToggle');
        var scheduleGroupRenameForm = document.getElementById('scheduleGroupRenameForm');

        function getMonthlyCheckboxes() {
            var container = document.getElementById('monthlyItems');
            if (!container) return [];
            return Array.prototype.slice.call(container.querySelectorAll('.monthlyItemCheckbox'));
        }

        function getSelectedMonthlyIds() {
            return getMonthlyCheckboxes().filter(function (cb) { return cb.checked; }).map(function (cb) { return cb.value; });
        }

        function setHiddenMonthlyIds(form, ids) {
            if (!form) return;
            form.querySelectorAll('input[data-monthly-selected="1"]').forEach(function (n) { n.remove(); });
            ids.forEach(function (id) {
                var inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'item_ids';
                inp.value = id;
                inp.setAttribute('data-monthly-selected', '1');
                form.appendChild(inp);
            });
        }

        function syncMonthlySelectedUi() {
            var ids = getSelectedMonthlyIds();
            if (monthlySelectedCount) {
                monthlySelectedCount.textContent = '(' + ids.length + ' selected)';
            }
            var has = ids.length > 0;
            if (monthlyBulkDeleteBtn) monthlyBulkDeleteBtn.disabled = !has;
            if (monthlySelectAll) {
                var all = getMonthlyCheckboxes();
                var allChecked = all.length > 0 && all.every(function (cb) { return cb.checked; });
                monthlySelectAll.checked = allChecked;
            }
        }

        if (monthlySelectAll) {
            monthlySelectAll.addEventListener('change', function () {
                var all = getMonthlyCheckboxes();
                all.forEach(function (cb) { cb.checked = monthlySelectAll.checked; });
                syncMonthlySelectedUi();
            });
        }

        getMonthlyCheckboxes().forEach(function (cb) {
            cb.addEventListener('change', syncMonthlySelectedUi);
        });

        if (monthlyBulkDeleteBtn && monthlyBulkDeleteForm) {
            monthlyBulkDeleteBtn.addEventListener('click', function () {
                if (!confirm('Delete selected monthly items?')) return;
                var ids = getSelectedMonthlyIds();
                setHiddenMonthlyIds(monthlyBulkDeleteForm, ids);
                monthlyBulkDeleteForm.submit();
            });
        }

        function getRowCheckboxes() {
            var container = document.getElementById('weeklyItems');
            if (!container) return [];
            return Array.prototype.slice.call(container.querySelectorAll('.weeklyRowCheckbox'));
        }

        function getSelectedIds() {
            return getRowCheckboxes().filter(function (cb) { return cb.checked; }).map(function (cb) { return cb.value; });
        }

        function syncSelectedUi() {
            var ids = getSelectedIds();
            if (selectedCount) {
                selectedCount.textContent = '(' + ids.length + ' selected)';
            }
            var has = ids.length > 0;
            if (bulkDeleteBtn) bulkDeleteBtn.disabled = !has;
            if (bulkUpdateToggle) bulkUpdateToggle.disabled = !has;
            if (bulkUpdateForm) {
                var hidden = bulkUpdateForm.querySelector('input[name="row_ids"]');
                if (hidden) hidden.value = ids.join(',');
            }
            if (bulkDeleteForm) {
                var hidden2 = bulkDeleteForm.querySelector('input[name="row_ids"]');
                if (hidden2) hidden2.value = ids.join(',');
            }
            if (selectAll) {
                var all = getRowCheckboxes();
                var allChecked = all.length > 0 && all.every(function (cb) { return cb.checked; });
                selectAll.checked = allChecked;
            }
        }

        if (selectAll) {
            selectAll.addEventListener('change', function () {
                var all = getRowCheckboxes();
                all.forEach(function (cb) { cb.checked = selectAll.checked; });
                syncSelectedUi();
            });
        }

        getRowCheckboxes().forEach(function (cb) {
            cb.addEventListener('change', syncSelectedUi);
        });

        if (bulkUpdateToggle && bulkPanel) {
            bulkUpdateToggle.addEventListener('click', function () {
                bulkPanel.classList.toggle('hidden');
            });
        }
        if (bulkCancel && bulkPanel) {
            bulkCancel.addEventListener('click', function () {
                bulkPanel.classList.add('hidden');
            });
        }

        function setHiddenIds(form, ids) {
            if (!form) return;
            form.querySelectorAll('input[data-weekly-selected="1"]').forEach(function (n) { n.remove(); });
            ids.forEach(function (id) {
                var inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'row_ids';
                inp.value = id;
                inp.setAttribute('data-weekly-selected', '1');
                form.appendChild(inp);
            });
        }

        if (bulkDeleteBtn && bulkDeleteForm) {
            bulkDeleteBtn.addEventListener('click', function () {
                if (!confirm('Delete selected timetable rows?')) return;
                var ids = getSelectedIds();
                setHiddenIds(bulkDeleteForm, ids);
                bulkDeleteForm.submit();
            });
        }

        if (bulkUpdateForm) {
            bulkUpdateForm.addEventListener('submit', function (e) {
                var ids = getSelectedIds();
                setHiddenIds(bulkUpdateForm, ids);
            });
        }

        if (scheduleGroupEditToggle && scheduleGroupRenameForm) {
            scheduleGroupEditToggle.addEventListener('click', function () {
                scheduleGroupRenameForm.classList.toggle('hidden');
            });
        }

        syncSelectedUi();
        syncMonthlySelectedUi();
    })();
</script>
{% endblock %}
